  {
    "_id": "matching_elite_learner",
    "public": {
      "node_data": {
        "jsonSchema": {
          "title": "MatchingLogData",
          "type": "object",
          "properties": {
            "_id": { "type": "string" },
            "elite_id": {
              "type": "string",
              "description": "ID của Elite Partner."
            },
            "learner_id": {
              "type": "string",
              "description": "ID của Learner."
            },
            "matched_at": {
              "type": "string",
              "format": "date-time",
              "description": "Thời điểm ghép cặp."
            },
            "end_at": {
              "type": "string",
              "format": "date-time",
              "description": "Thời điểm kết thúc mối quan hệ matching."
            },
            "status": {
              "type": "string",
              "enum": ["pending", "active", "terminated"],
              "description": "Trạng thái của mối quan hệ matching."
            },
            "log": {
              "type": "object",
              "properties": {
                "elite_rank": {
                  "type": "integer",
                  "description": "Thứ hạng của Elite Partner."
                },
                "learner_rank": {
                  "type": "integer",
                  "description": "Thứ hạng của Learner."
                }
              }
            },
            "wants_matching": {
              "type": "boolean",
              "description": "Learner có muốn tìm kiếm sự hỗ trợ từ Elite hay không."
            },
            "signature": {
              "type": "string",
              "description": "Chữ ký số của Learner nếu họ đồng ý matching."
            }
          },
          "required": [
            "_id",
            "elite_id",
            "learner_id",
            "matched_at",
            "end_at",
            "status",
            "log",
            "wants_matching"
          ],
          "additionalProperties": false
        },
        "jsonSample": [
          {
            "_id": "12345_67890_2025-01-01T00:00:00Z",
            "elite_id": "12345",
            "learner_id": "67890",
            "matched_at": "2025-01-01T00:00:00Z",
            "end_at": "2025-01-08T00:00:00Z",
            "status": "pending",
            "log": {
              "elite_rank": 1,
              "learner_rank": 10
            },
            "wants_matching": true,
            "signature": "signature_of_learner"
          },
          {
            "_id": "54321_09876_2025-01-02T00:00:00Z",
            "elite_id": "54321",
            "learner_id": "09876",
            "matched_at": "2025-01-02T00:00:00Z",
            "end_at": "2025-01-09T00:00:00Z",
            "status": "active",
            "log": {
              "elite_rank": 2,
              "learner_rank": 20
            },
            "wants_matching": true,
            "signature": "signature_of_learner"
          }
        ]
      }
    },
    "private": {
      "node_function": {
        "edge": [
          {
            "pipeline": [
              {
                "$match": {
                  "user_id": "USER_ID_FROM_CLIENT",
                  "wants_matching": true
                }
              },
              {
                "$lookup": {
                  "from": "collection_cards",
                  "localField": "user_id",
                  "foreignField": "user_id",
                  "as": "card_data"
                }
              },
              {
                "$lookup": {
                  "from": "collection_elite_partner",
                  "localField": "user_id",
                  "foreignField": "user_id",
                  "as": "elite_partner_data"
                }
              },
              {
                "$addFields": {
                  "is_elite_partner": {
                    "$gt": [{ "$size": "$elite_partner_data" }, 0]
                  }
                }
              },
              {
                "$project": {
                  "user_id": 1,
                  "wants_matching": 1,
                  "elite_id": {
                    "$cond": {
                      "if": "$is_elite_partner",
                      "then": "$user_id",
                      "else": null
                    }
                  },
                  "learner_id": {
                    "$cond": {
                      "if": "$is_elite_partner",
                      "then": null,
                      "else": "$user_id"
                    }
                  }
                }
              },
              {
                "$merge": {
                  "into": "matching_elite_learner",
                  "on": "_id",
                  "whenMatched": "merge",
                  "whenNotMatched": "insert"
                }
              }
            ],
            "purpose": "Pipeline để xác định Learner có muốn matching với Elite Partner hay không.",
            "data_input_from_node": [
              "collection_elite_partner",
              "collection_leaderboard"
            ],
            "data_output_to_node": "matching_elite_learner"
          },
          {
            "pipeline": [
              {
                "$match": {
                  "status": "pending",
                  "wants_matching": true
                }
              },
              {
                "$lookup": {
                  "from": "collection_cards",
                  "localField": "learner_id",
                  "foreignField": "user_id",
                  "as": "card_data"
                }
              },
              {
                "$unwind": "$card_data"
              },
              {
                "$addFields": {
                  "signature": "$card_data.signature",
                  "is_signature_valid": true
                }
              },
              {
                "$merge": {
                  "into": "matching_logs",
                  "on": "_id",
                  "whenMatched": "merge",
                  "whenNotMatched": "insert"
                }
              }
            ],
            "purpose": "Pipeline xử lý matching dựa trên lựa chọn của Learner.",
            "data_input_from_node": [
              "matching_elite_learner",
              "collection_cards"
            ],
            "data_output_to_node": "matching_logs"
          },
          {
            "pipeline": [
              {
                "$match": {
                  "is_elite_partner": true,
                  "status": "active"
                }
              },

              {
                "$lookup": {
                  "from": "collection_leaderboard",
                  "localField": "user_id",
                  "foreignField": "user_id",
                  "as": "leaderboard_data"
                }
              },
              {
                "$unwind": "$leaderboard_data"
              },
              {
                "$addFields": {
                  "elite_rank": "$leaderboard_data.rank"
                }
              },

              {
                "$lookup": {
                  "from": "collection_leaderboard",
                  "let": { "current_user_id": "$user_id" },
                  "pipeline": [
                    {
                      "$match": {
                        "$expr": {
                          "$and": [
                            { "$ne": ["$user_id", "$$current_user_id"] },
                            {
                              "$or": [
                                { "$gt": ["$rank", 20] },
                                { "$eq": ["$rank", null] }
                              ]
                            },
                            { "$eq": ["$wants_matching", true] }
                          ]
                        }
                      }
                    }
                  ],
                  "as": "eligible_learners"
                }
              },
              {
                "$unwind": "$eligible_learners"
              },

              {
                "$lookup": {
                  "from": "matching_logs",
                  "localField": "user_id",
                  "foreignField": "elite_id",
                  "as": "existing_matches"
                }
              },
              {
                "$addFields": {
                  "current_match_count": { "$size": "$existing_matches" }
                }
              },
              {
                "$match": {
                  "current_match_count": { "$lt": 3 }
                }
              },

              {
                "$lookup": {
                  "from": "matching_logs",
                  "localField": "eligible_learners.user_id",
                  "foreignField": "learner_id",
                  "as": "learner_existing_matches"
                }
              },
              {
                "$addFields": {
                  "learner_existing_match_count": {
                    "$size": "$learner_existing_matches"
                  }
                }
              },
              {
                "$match": {
                  "learner_existing_match_count": 0
                }
              },

              {
                "$addFields": {
                  "learner_id": "$eligible_learners.user_id",
                  "learner_rank": "$eligible_learners.rank",
                  "matched_at": "$$NOW",
                  "end_at": {
                    "$dateAdd": {
                      "startDate": "$$NOW",
                      "unit": "week",
                      "amount": 1
                    }
                  },
                  "status": "pending",
                  "wants_matching": true
                }
              },

              {
                "$project": {
                  "_id": {
                    "$concat": [
                      "$user_id",
                      "_",
                      "$eligible_learners.user_id",
                      "_",
                      { "$toString": "$$NOW" }
                    ]
                  },
                  "elite_id": "$user_id",
                  "learner_id": 1,
                  "matched_at": 1,
                  "end_at": 1,
                  "status": 1,
                  "log": {
                    "elite_rank": "$elite_rank",
                    "learner_rank": "$learner_rank"
                  },
                  "wants_matching": 1,
                  "signature": "$eligible_learners.user_id"
                }
              },

              {
                "$merge": {
                  "into": "matching_logs",
                  "on": "_id",
                  "whenMatched": "merge",
                  "whenNotMatched": "insert"
                }
              }
            ],
            "purpose": "Pipeline for automatically matching Elite Partners with Learners based on rank and status.",
            "data_input_from_node": [
              "elite_partners",
              "leaderboard",
              "matching_logs"
            ],
            "data_output_to_node": "matching_logs"
          }
        ]
      }
    },
    "personal": {
      "node_info": {
        "name": "English Test System",
        "author": "Joshept",
        "version": "1.0",
        "year": "2025"
      }
    }
  }
