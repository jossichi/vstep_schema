[
  {
    "_id": "admin_collection_cards",
    "public": {
      "node_data": {
        "jsonSchema": {
          "$schema": "http://json-schema.org/draft-07/schema#",
          "title": "AdminCardData",
          "type": "object",
          "properties": {
            "_id": { "type": "string" },
            "admin_card_id": {
              "type": "string",
              "unique": true,
              "description": "Mã định danh duy nhất của thẻ dành cho admin (định dạng AC-<ECDSA>)"
            },

            "public_key": {
              "type": "string",
              "description": "Khóa công khai để xác thực chữ ký số"
            },
            "token": { "type": "string", "required": true },
            "qr_code": {
              "type": "string",
              "description": "Mã QR chứa thông tin xác thực (đã mã hóa)"
            },
            "admin_signature": {
              "type": "string",
              "description": "Chữ ký số được tạo bởi ví của người dùng là admin "
            },
            "status": {
              "type": "string",
              "enum": ["active", "blocked"],
              "description": "Trạng thái thẻ"
            },

            "created_at": {
              "type": "string",
              "format": "date-time",
              "description": "Thời gian tạo thẻ"
            },
            "hashed_adminID": {
              "type": "string",
              "unique": true,
              "description": "Mã băm của ID admin (MÃ NHÂN VIÊN CỦA ADMIN) (định dạng ADMIN-<UUID>)"
            },
            "role": {
              "type": "string",
              "enum": ["superadmin", "admin"],
              "default": "admin",
              "description": "Vai trò của admin"
            },
            "permissions": {
              "type": "array",
              "items": { "type": "string" },
              "description": "Danh sách quyền (ví dụ: ['create_card', 'delete_user'])"
            },
            "last_login": {
              "type": "string",
              "format": "date-time",
              "description": "Thời gian đăng nhập gần nhất"
            },
            "active_sessions": {
              "type": "integer",
              "default": 0,
              "description": "Số phiên đăng nhập đang hoạt động"
            }
          },
          "required": [
            "_id",
            "admin_card_id",
            "public_key",
            "qr_code",
            "token",
            "status",
            "created_at",
            "hashed_adminID"
          ]
        },
        "jsonSample": []
      }
    },
    "private": {
      "node_function": {
        "edge": [
          {
            "pipeline": [
              {
                "$setWindowFields": {
                  "output": {
                    "employee_input": "$$employee_id"
                  }
                }
              },
              {
                "$addFields": {
                  "hashed_adminID": {
                    "$function": {
                      "body": "function() { const crypto = require('crypto'); const uuid = crypto.randomBytes(16).toString('hex'); return 'ADMIN-' + uuid; }",
                      "args": ["$employee_input"],
                      "lang": "js"
                    }
                  }
                }
              },
              {
                "$addFields": {
                  "key_pair": {
                    "$function": {
                      "body": "function() { const crypto = require('crypto'); const { publicKey, privateKey } = crypto.generateKeyPairSync('ec', { namedCurve: 'secp256k1', publicKeyEncoding: { type: 'spki', format: 'pem' }, privateKeyEncoding: { type: 'pkcs8', format: 'pem' } }); return { publicKey, privateKey }; }",
                      "args": [],
                      "lang": "js"
                    }
                  }
                }
              },
              {
                "$addFields": {
                  "admin_card_id": {
                    "$function": {
                      "body": "function(privateKey) { const crypto = require('crypto'); const bs58 = require('bs58'); const seed = crypto.randomBytes(16); const hash = crypto.createHash('sha256').update(seed).digest(); const sign = crypto.createSign('SHA256'); sign.update(hash); sign.end(); const admin_signature = sign.sign({ key: privateKey, format: 'pem', type: 'sec1' }, 'base64'); return 'AC-' + bs58.encode(Buffer.from(admin_signature, 'base64')); }",
                      "args": ["$private_key"],
                      "lang": "js"
                    }
                  }
                }
              },
              {
                "$addFields": {
                  "public_key": "$key_pair.publicKey",
                  "private_key": "$key_pair.privateKey"
                }
              },
              {
                "$addFields": {
                  "raw_qr_data": {
                    "admin_id": "$admin_id",
                    "admin_card_id": "$admin_card_id",
                    "public_key": "$public_key"
                  }
                }
              },
              {
                "$addFields": {
                  "encrypted_qr_data": {
                    "$function": {
                      "body": "function(data, secretKey) { const crypto = require('crypto'); const cipher = crypto.createCipher('aes-256-cbc', secretKey); let encrypted = cipher.update(JSON.stringify(data), 'utf8', 'hex'); encrypted += cipher.final('hex'); return encrypted; }",
                      "args": ["$raw_qr_data", "jwt-secret-key"],
                      "lang": "js"
                    }
                  }
                }
              },
              {
                "$addFields": {
                  "admin_signature": {
                    "$function": {
                      "body": "function(privateKey, qr_data) { const crypto = require('crypto'); const sign = crypto.createSign('SHA256'); sign.update(qr_data); sign.end(); return sign.sign(privateKey, 'base64'); }",
                      "args": ["$private_key", "$encrypted_qr_data"],
                      "lang": "js"
                    }
                  }
                }
              },
              {
                "$addFields": {
                  "qr_code": {
                    "$function": {
                      "body": "function(encryptedData, sig) { return `https://example.com/cards/decrypt?data=${encodeURIComponent(encryptedData)}&admin_signature=${encodeURIComponent(sig)}`; }",
                      "args": ["$encrypted_qr_data", "$admin_signature"],
                      "lang": "js"
                    }
                  }
                }
              },

              {
                "$addFields": {
                  "hashed_adminID": {
                    "$function": {
                      "body": "function(input) { const crypto = require('crypto'); return crypto.createHash('sha256').update(input).digest('hex'); }",
                      "args": ["$admin_id"],
                      "lang": "js"
                    }
                  }
                }
              },
              {
                "$unset": ["key_pair", "private_key", "raw_qr_data"]
              },
              {
                "$merge": {
                  "into": "admin_collection_cards",
                  "on": "_id",
                  "whenMatched": "merge",
                  "whenNotMatched": "insert"
                }
              }
            ],
            "purpose": "Create admin cards with admin_id in ADMIN-<UUID> format and additional admin-specific fields.",
            "data_input_from_node": [],
            "data_output_to_node": []
          }
        ]
      }
    },
    "personal": {
      "node_info": {
        "name": "English Test System",
        "author": "Joshept",
        "version": "1.0",
        "year": "2025"
      }
    }
  },

  {
    "_id": "admin_draft_tests",
    "public": {
      "node_data": {
        "jsonSchema": {
          "$schema": "http://json-schema.org/draft-07/schema#",
          "title": "DraftTestSchema",
          "type": "object",
          "properties": {
            "_id": "string",
            "test_id": "string",
            "admin_card_id": {
              "type": "string",
              "unique": true,
              "description": "truy vấn trong admin_collection_cards"
            },
            "admin_signature": {
              "type": "string",
              "description": "truy vấn trong admin_collection_cards"
            },
            "superadmin_signature": {
              "type": "string",
              "description": "truy vấn trong admin_collection_cards"
            },
            "admin_signed_at": {
              "type": "date-time",
              "description": "Thời gian admin ký"
            },
            "superadmin_signed_at": {
              "type": "date-time",
              "description": "Thời gian superadmin ký"
            },
            "rejected_reason": {
              "type": "string",
              "description": "Lý do bài test bị từ chối bởi admin hoặc superadmin"
            },
            "test_type": { "type": "string", "enum": ["listening", "reading"] },
            "level": { "type": "string", "enum": ["B1", "B2", "C1"] },
            "created_by": "string",
            "created_at": "date-time",
            "status": {
              "type": "string",
              "enum": ["draft", "pending_review", "rejected", "approved"],
              "default": "draft",
              "description": "Trạng thái của bài kiểm tra"
            }
          },
          "allOf": [
            {
              "if": {
                "properties": { "test_type": { "const": "listening" } }
              },
              "then": {
                "properties": {
                  "audio_url": {
                    "type": "string",
                    "format": "uri",
                    "description": "URL của file audio. Trường này chứa URL của file audio, dù là từ upload hoặc nhập trực tiếp."
                  },
                  "questions": {
                    "type": "array",
                    "items": {
                      "type": "object",
                      "properties": {
                        "question_id": { "type": "string" },
                        "question_text": { "type": "string" },
                        "options": {
                          "type": "array",
                          "items": { "type": "string" },
                          "minItems": 4,
                          "maxItems": 4
                        },
                        "correct_answer": { "type": "string" }
                      },
                      "required": [
                        "question_id",
                        "question_text",
                        "options",
                        "correct_answer",
                        "audio_url"
                      ]
                    }
                  }
                },
                "required": ["audio_url", "questions"]
              }
            },
            {
              "if": { "properties": { "test_type": { "const": "reading" } } },
              "then": {
                "properties": {
                  "instructions": { "type": "string" },
                  "passages": {
                    "type": "array",
                    "minItems": 4,
                    "maxItems": 4,
                    "items": {
                      "type": "object",
                      "properties": {
                        "passage_id": { "type": "string" },
                        "question_text": {
                          "type": "string",
                          "description": "Nội dung đoạn văn hoặc câu hỏi"
                        },
                        "questions": {
                          "type": "array",
                          "items": {
                            "type": "object",
                            "properties": {
                              "question_id": { "type": "string" },
                              "question_type": {
                                "type": "string",
                                "enum": ["multiple_choice", "short_answer"]
                              },
                              "text": { "type": "string" },
                              "options": {
                                "type": "array",
                                "items": { "type": "string" },
                                "minItems": 4,
                                "maxItems": 4
                              },
                              "correct_answer": { "type": "string" }
                            },
                            "required": [
                              "question_id",
                              "question_type",
                              "text",
                              "correct_answer"
                            ],
                            "allOf": [
                              {
                                "if": {
                                  "properties": {
                                    "question_type": {
                                      "const": "multiple_choice"
                                    }
                                  }
                                },
                                "then": {
                                  "required": ["options", "correct_answer"]
                                }
                              },
                              {
                                "if": {
                                  "properties": {
                                    "question_type": {
                                      "const": "short_answer"
                                    }
                                  }
                                },
                                "then": { "required": ["correct_answer"] }
                              }
                            ]
                          }
                        }
                      },
                      "required": ["passage_id", "question_text", "questions"]
                    }
                  }
                },
                "required": ["level", "instructions", "passages"]
              }
            }
          ],
          "additionalProperties": false
        },
        "jsonSample": [
          {
            "_id": "DRAFT_001",
            "test_id": "TEST_123456",
            "admin_card_id": "AC123456789",
            "admin_signature": "base64-encoded-signature",
            "test_type": "listening",
            "level": "B2",
            "created_by": "ADMIN-1a2b3c4d5e6f7890",
            "created_at": "2025-02-14T18:26:02.588Z",
            "status": "draft",
            "audio_url": "https://example.com/audio.mp3",
            "questions": [
              {
                "question_id": "Q1",
                "question_text": "What is the main idea of the audio?",
                "options": ["Option A", "Option B", "Option C", "Option D"],
                "correct_answer": "Option A"
              }
            ]
          },
          {
            "_id": "DRAFT_002",
            "test_id": "TEST_654321",
            "admin_card_id": "AC987654321",
            "admin_signature": "base64-encoded-signature",
            "test_type": "reading",
            "level": "C1",
            "created_by": "ADMIN-0a1b2c3d4e5f6789",
            "created_at": "2025-02-14T18:26:02.588Z",
            "status": "draft",
            "instructions": "Read the following passages and answer the questions.",
            "passages": [
              {
                "passage_id": "P1",
                "question_text": "Passage 1 content here.",
                "questions": [
                  {
                    "question_id": "Q1",
                    "question_type": "multiple_choice",
                    "text": "What is the main point of this passage?",
                    "options": ["A", "B", "C", "D"],
                    "correct_answer": "A"
                  },
                  {
                    "question_id": "Q2",
                    "question_type": "short_answer",
                    "text": "Explain the significance of the passage.",
                    "correct_answer": "Significance explanation here."
                  }
                ]
              }
            ]
          }
        ]
      }
    },
    "private": {
      "node_function": {
        "edge": [
          {
            "pipeline": [
              {
                "$match": {
                  "admin_card_id": { "$exists": true },
                  "test_type": { "$in": ["listening", "reading"] }
                }
              },
              {
                "$lookup": {
                  "from": "admin_collection_cards",
                  "localField": "admin_card_id",
                  "foreignField": "card_id",
                  "as": "admin_card_data"
                }
              },
              {
                "$unwind": "$admin_card_data"
              },
              {
                "$addFields": {
                  "is_admin_verified": {
                    "$cond": {
                      "if": { "$eq": ["$admin_card_data.status", "active"] },
                      "then": true,
                      "else": false
                    }
                  }
                }
              },
              {
                "$match": {
                  "is_admin_verified": true
                }
              },
              {
                "$addFields": {
                  "audio_processed": {
                    "$cond": {
                      "if": { "$ne": ["$audio_file", null] },
                      "then": {
                        "$function": {
                          "body": "function(audioFile) { const crypto = require('crypto'); const hash = crypto.createHash('sha256'); hash.update(audioFile); return hash.digest('hex'); }",
                          "args": ["$audio_file"],
                          "lang": "js"
                        }
                      },
                      "else": "$audio_url"
                    }
                  }
                }
              },
              {
                "$addFields": {
                  "final_audio_url": {
                    "$cond": {
                      "if": { "$ne": ["$audio_file", null] },
                      "then": "$audio_processed",
                      "else": "$audio_url"
                    }
                  }
                }
              },
              {
                "$match": {
                  "admin_signature": { "$exists": true }
                }
              },
              {
                "$addFields": {
                  "signature_verified": {
                    "$function": {
                      "body": "function(signature, publicKey) { const crypto = require('crypto'); const verify = crypto.createVerify('SHA256'); verify.update(JSON.stringify({ test_id: this.test_id, final_audio_url: this.final_audio_url })); verify.end(); return verify.verify(publicKey, signature, 'base64'); }",
                      "args": [
                        "$admin_signature",
                        "$admin_card_data.public_key"
                      ],
                      "lang": "js"
                    }
                  }
                }
              },
              {
                "$match": {
                  "signature_verified": true
                }
              },
              {
                "$merge": {
                  "into": "admin_draft_tests",
                  "on": "_id",
                  "whenMatched": "merge",
                  "whenNotMatched": "insert"
                }
              }
            ],
            "purpose": "Xử lý và xác minh dữ liệu đề thi trước khi lưu vào cơ sở dữ liệu.",
            "data_input_from_node": ["admin_collection_cards"],
            "data_output_to_node": ["admin_draft_tests"]
          },
          {
            "pipeline": [
              {
                "$match": {
                  "status": "pending_review",
                  "test_id": { "$exists": true }
                }
              },
              {
                "$lookup": {
                  "from": "admin_collection_cards",
                  "localField": "superadmin_card_id",
                  "foreignField": "card_id",
                  "as": "superadmin_card_data"
                }
              },
              { "$unwind": "$superadmin_card_data" },
              {
                "$addFields": {
                  "is_superadmin_verified": {
                    "$cond": {
                      "if": {
                        "$eq": ["$superadmin_card_data.status", "active"]
                      },
                      "then": true,
                      "else": false
                    }
                  }
                }
              },
              { "$match": { "is_superadmin_verified": true } },
              {
                "$set": {
                  "status": "approved",
                  "superadmin_signature": "$superadmin_card_data.signature",
                  "superadmin_signed_at": { "$toDate": "$$NOW" }
                }
              },
              {
                "$merge": {
                  "into": "admin_draft_tests",
                  "on": "_id",
                  "whenMatched": "merge"
                }
              },
              {
                "$project": {
                  "_id": "$test_id",
                  "test_type": 1,
                  "level": 1,
                  "audio_url": 1,
                  "questions": 1,
                  "instructions": 1,
                  "passages": 1,
                  "admin_signature": 1,
                  "admin_signed_at": 1,
                  "superadmin_signature": 1,
                  "superadmin_signed_at": 1
                }
              },
              {
                "$merge": {
                  "into": "collection_tests",
                  "on": "_id",
                  "whenMatched": "merge",
                  "whenNotMatched": "insert"
                }
              }
            ],
            "purpose": "Superadmin kiểm duyệt lần 2 và duyệt đề thi chính thức.",
            "data_input_from_node": ["admin_draft_tests"],
            "data_output_to_node": ["collection_tests"]
          },
          {
            "pipeline": [
              {
                "$match": {
                  "status": "pending_review",
                  "test_id": { "$exists": true }
                }
              },
              {
                "$set": {
                  "status": "rejected",
                  "rejected_by": "superadmin-id",
                  "rejected_at": { "$toDate": "$$NOW" },
                  "rejected_reason": "{{rejected_reason}}",
                  "superadmin_signature": "{{superadmin_signature}}",
                  "superadmin_signed_at": "{{superadmin_signed_at}}"
                }
              },
              {
                "$merge": {
                  "into": "admin_draft_tests",
                  "on": "_id",
                  "whenMatched": "merge"
                }
              }
            ],
            "purpose": "Superadmin từ chối đề thi chưa đạt chuẩn và giữ lại để admin chỉnh sửa.",
            "data_input_from_node": ["admin_draft_tests"],
            "data_output_to_node": ["admin_draft_tests"]
          }
        ]
      }
    },
    "personal": {
      "node_info": {
        "name": "English Test System",
        "author": "Joshept",
        "version": "1.0",
        "year": "2025"
      }
    }
  },

  {
    "_id": "admin_draft_practice_materials",
    "public": {
      "node_data": {
        "jsonSchema": {
          "_id": "string",
          "practice_id": "string",
          "admin_card_id": {
            "type": "string",
            "unique": true,
            "description": "Tham chiếu đến thẻ admin trong `admin_collection_cards`"
          },
          "admin_signature": {
            "type": "string",
            "description": "Chữ ký số của admin xác thực bài kiểm tra"
          },
          "test_type": { "type": "string", "enum": ["listening", "reading"] },
          "level": { "type": "string", "enum": ["B1", "B2", "C1"] },
          "created_by": "string",
          "created_at": "date-time",
          "status": {
            "type": "string",
            "enum": ["draft", "pending_review", "rejected"],
            "description": "Trạng thái của tài liệu thực hành"
          },
          "listening": {
            "type": "array",
            "minItems": 3,
            "maxItems": 3,
            "items": {
              "type": "object",
              "properties": {
                "part": {
                  "type": "integer",
                  "minimum": 1,
                  "maximum": 3
                },
                "audio_url": {
                  "type": "string",
                  "description": "Either a Base64-encoded audio file or a URL pointing to an audio file.",
                  "oneOf": [{ "format": "base64" }, { "format": "uri" }]
                },
                "questions": {
                  "type": "array",
                  "minItems": 1,
                  "maxItems": 15,
                  "items": {
                    "type": "object",
                    "properties": {
                      "question_id": { "type": "string" },
                      "question_text": { "type": "string" },
                      "options": {
                        "type": "array",
                        "minItems": 3,
                        "maxItems": 5,
                        "items": { "type": "string" }
                      },
                      "correct_answer": { "type": "string" }
                    },
                    "required": [
                      "question_id",
                      "question_text",
                      "options",
                      "correct_answer"
                    ]
                  }
                }
              },
              "required": ["part", "audio_url", "questions"]
            }
          },
          "reading": {
            "type": "array",
            "minItems": 4,
            "maxItems": 4,
            "items": {
              "type": "object",
              "properties": {
                "part": { "type": "integer", "minimum": 1, "maximum": 4 },
                "passage_id": { "type": "string" },
                "text": { "type": "string" },
                "questions": {
                  "type": "array",
                  "minItems": 1,
                  "maxItems": 15,
                  "items": {
                    "type": "object",
                    "properties": {
                      "question_id": { "type": "string" },
                      "question_text": { "type": "string" },
                      "options": {
                        "type": "array",
                        "minItems": 3,
                        "maxItems": 5,
                        "items": { "type": "string" }
                      },
                      "correct_answer": { "type": "string" }
                    },
                    "required": [
                      "question_id",
                      "question_text",
                      "options",
                      "correct_answer"
                    ]
                  }
                }
              },
              "required": ["part", "passage_id", "text", "questions"]
            }
          },
          "writing": {
            "type": "array",
            "minItems": 2,
            "maxItems": 2,
            "items": {
              "type": "object",
              "properties": {
                "part": { "type": "integer", "minimum": 1, "maximum": 2 },
                "prompt": { "type": "string" },
                "sample_answer": { "type": "string" }
              },
              "required": ["part", "prompt", "sample_answer"]
            }
          },
          "speaking": {
            "type": "array",
            "minItems": 3,
            "maxItems": 3,
            "items": {
              "type": "object",
              "properties": {
                "part": { "type": "integer", "minimum": 1, "maximum": 3 },
                "prompt": { "type": "string" },
                "sample_answer": { "type": "string" }
              },
              "required": ["part", "prompt", "sample_answer"]
            }
          }
        },
        "jsonSample": [
          {
            "_id": "DRAFT_PRACTICE_001",
            "practice_id": "PRACTICE_123456",
            "admin_card_id": "AC123456789",
            "admin_signature": "base64-encoded-signature",
            "test_type": "listening",
            "level": "B2",
            "created_by": "ADMIN-1a2b3c4d5e6f7890",
            "created_at": "2025-02-14T18:26:02.588Z",
            "status": "draft",
            "listening": [
              {
                "part": 1,
                "audio_url": "https://example.com/audio.mp3",
                "questions": [
                  {
                    "question_id": "Q1",
                    "question_text": "What is the main idea of the audio?",
                    "options": ["Option A", "Option B", "Option C", "Option D"],
                    "correct_answer": "Option A"
                  }
                ]
              }
            ],
            "reading": [
              {
                "part": 1,
                "passage_id": "P1",
                "text": "Passage content here.",
                "questions": [
                  {
                    "question_id": "Q1",
                    "question_text": "What is the main point of this passage?",
                    "options": ["A", "B", "C", "D"],
                    "correct_answer": "A"
                  }
                ]
              }
            ],
            "writing": [
              {
                "part": 1,
                "prompt": "Write an essay about the importance of education.",
                "sample_answer": "Education is crucial for personal and societal development."
              },
              {
                "part": 2,
                "prompt": "Describe your favorite book and its impact on you.",
                "sample_answer": "My favorite book is '1984' by George Orwell, which opened my eyes to the dangers of totalitarianism."
              },
              {
                "part": 3,
                "prompt": "Discuss the role of technology in modern education.",
                "sample_answer": "Technology has revolutionized education by providing access to vast resources and enabling online learning."
              }
            ],
            "speaking": [
              {
                "part": 1,
                "prompt": "Describe a memorable event in your life.",
                "sample_answer": "One of the most memorable events in my life was my graduation day, which marked the culmination of years of hard work."
              },
              {
                "part": 2,
                "prompt": "Discuss your favorite hobby and why you enjoy it.",
                "sample_answer": "My favorite hobby is painting, as it allows me to express my creativity and relax."
              },
              {
                "part": 3,
                "prompt": "Explain the importance of learning a second language.",
                "sample_answer": "Learning a second language opens up new opportunities for communication and understanding different cultures."
              }
            ]
          }
        ]
      }
    },
    "private": {
      "node_function": {
        "edge": [
          {
            "pipeline": [
              {
                "$match": {
                  "admin_card_id": { "$exists": true }
                }
              },
              {
                "$lookup": {
                  "from": "admin_collection_cards",
                  "localField": "admin_card_id",
                  "foreignField": "card_id",
                  "as": "admin_card_data"
                }
              },
              {
                "$unwind": "$admin_card_data"
              },
              {
                "$match": {
                  "admin_card_data.status": "active"
                }
              },
              {
                "$merge": {
                  "into": "admin_draft_practice_materials",
                  "on": "_id",
                  "whenMatched": "merge",
                  "whenNotMatched": "insert"
                }
              }
            ],
            "purpose": "Kiểm tra quyền admin thông qua admin_card_id và xác minh trạng thái thẻ.",
            "data_input_from_node": ["admin_collection_cards"],
            "data_output_to_node": ["admin_draft_practice_materials"]
          },
          {
            "pipeline": [
              {
                "$addFields": {
                  "processed_audio_url": {
                    "$cond": {
                      "if": {
                        "$regexMatch": {
                          "input": "$audio_url",
                          "regex": "^https?://.*$"
                        }
                      },
                      "then": "$audio_url",
                      "else": {
                        "$function": {
                          "body": "function(audioFile) { const crypto = require('crypto'); const hash = crypto.createHash('sha256'); hash.update(audioFile); return hash.digest('hex'); }",
                          "args": ["$audio_url"],
                          "lang": "js"
                        }
                      }
                    }
                  }
                }
              },
              {
                "$merge": {
                  "into": "admin_draft_practice_materials",
                  "on": "_id",
                  "whenMatched": "merge",
                  "whenNotMatched": "insert"
                }
              }
            ],
            "purpose": "Xử lý URL hoặc băm file audio trước khi lưu vào cơ sở dữ liệu.",
            "data_input_from_node": ["audio_url"],
            "data_output_to_node": ["admin_draft_practice_materials"]
          },
          {
            "pipeline": [
              {
                "$match": {
                  "status": "pending_review",
                  "admin_signature": { "$exists": false }
                }
              },
              {
                "$lookup": {
                  "from": "admin_collection_cards",
                  "localField": "admin_card_id",
                  "foreignField": "card_id",
                  "as": "admin_card_data"
                }
              },
              {
                "$unwind": "$admin_card_data"
              },
              {
                "$match": {
                  "admin_card_data.status": "active"
                }
              },
              {
                "$addFields": {
                  "requires_signature": true
                }
              },
              {
                "$merge": {
                  "into": "admin_draft_practice_materials",
                  "on": "_id",
                  "whenMatched": "merge",
                  "whenNotMatched": "insert"
                }
              }
            ],
            "purpose": "Yêu cầu chữ ký số từ admin sau khi đề thi đã hoàn thành.",
            "data_input_from_node": ["admin_collection_cards"],
            "data_output_to_node": ["admin_draft_practice_materials"]
          },
          {
            "pipeline": [
              {
                "$match": {
                  "status": "pending_review",
                  "admin_signature": { "$exists": true }
                }
              },
              {
                "$lookup": {
                  "from": "admin_collection_cards",
                  "localField": "admin_card_id",
                  "foreignField": "card_id",
                  "as": "admin_card_data"
                }
              },
              {
                "$unwind": "$admin_card_data"
              },
              {
                "$match": {
                  "admin_card_data.status": "active"
                }
              },
              {
                "$set": {
                  "status": "completed"
                }
              },
              {
                "$merge": {
                  "into": "admin_draft_practice_materials",
                  "on": "_id",
                  "whenMatched": "merge",
                  "whenNotMatched": "insert"
                }
              }
            ],
            "purpose": "Lưu dữ liệu vào cơ sở dữ liệu sau khi admin cung cấp chữ ký số và xác minh quyền admin.",
            "data_input_from_node": ["admin_collection_cards"],
            "data_output_to_node": ["admin_draft_practice_materials"]
          },
          {
            "pipeline": [
              {
                "$match": {
                  "status": "pending_review",
                  "test_id": { "$exists": true }
                }
              },
              {
                "$lookup": {
                  "from": "admin_collection_cards",
                  "localField": "superadmin_card_id",
                  "foreignField": "card_id",
                  "as": "superadmin_card_data"
                }
              },
              { "$unwind": "$superadmin_card_data" },
              {
                "$addFields": {
                  "is_superadmin_verified": {
                    "$cond": {
                      "if": {
                        "$eq": ["$superadmin_card_data.status", "active"]
                      },
                      "then": true,
                      "else": false
                    }
                  }
                }
              },
              { "$match": { "is_superadmin_verified": true } },
              {
                "$set": {
                  "status": "approved",
                  "superadmin_signature": "$superadmin_card_data.signature",
                  "superadmin_signed_at": { "$toDate": "$$NOW" }
                }
              },
              {
                "$merge": {
                  "into": "admin_draft_tests",
                  "on": "_id",
                  "whenMatched": "merge"
                }
              },
              {
                "$project": {
                  "_id": "$test_id",
                  "test_type": 1,
                  "level": 1,
                  "upload_date": 1,
                  "listening": 1,
                  "writing": 1,
                  "speaking": 1,
                  "admin_signature": 1,
                  "admin_signed_at": 1,
                  "superadmin_signature": 1,
                  "superadmin_signed_at": 1
                }
              },
              {
                "$merge": {
                  "into": "collection_tests",
                  "on": "_id",
                  "whenMatched": "merge",
                  "whenNotMatched": "insert"
                }
              }
            ],
            "purpose": "Superadmin kiểm duyệt lần 2 và duyệt đề thi chính thức.",
            "data_input_from_node": ["admin_draft_tests"],
            "data_output_to_node": ["collection_tests"]
          },
          {
            "pipeline": [
              {
                "$match": {
                  "status": "pending_review",
                  "test_id": { "$exists": true }
                }
              },
              {
                "$set": {
                  "status": "rejected",
                  "rejected_by": "superadmin-id",
                  "rejected_at": { "$toDate": "$$NOW" },
                  "rejected_reason": "{{rejected_reason}}",
                  "superadmin_signature": "{{superadmin_signature}}",
                  "superadmin_signed_at": "{{superadmin_signed_at}}"
                }
              },
              {
                "$merge": {
                  "into": "admin_draft_tests",
                  "on": "_id",
                  "whenMatched": "merge"
                }
              }
            ],
            "purpose": "Superadmin từ chối đề thi chưa đạt chuẩn và giữ lại để admin chỉnh sửa.",
            "data_input_from_node": ["admin_draft_tests"],
            "data_output_to_node": ["admin_draft_tests"]
          }
        ]
      }
    },
    "personal": {
      "node_info": {
        "name": "English Test System",
        "author": "Joshept",
        "version": "1.0",
        "year": "2025"
      }
    }
  },

  {
    "_id": "admin_blocked_cards",
    "public": {
      "node_data": {
        "jsonSchema": {
          "$schema": "http://json-schema.org/draft-07/schema#",
          "title": "BlockedCardSchema",
          "type": "object",
          "properties": {
            "_id": { "type": "string" },
            "card_id": {
              "type": "string",
              "description": "Tham chiếu đến `card_id` trong `collection_cards`"
            },
            "admin_card_id": {
              "type": "string",
              "unique": true,
              "description": "Mã định danh duy nhất của thẻ dành cho admin (định dạng AC-<ECDSA>)"
            },

            "user_id": {
              "type": "string",
              "description": "Tham chiếu đến `user_id` trong `collection_cards`"
            },
            "reason": {
              "type": "string",
              "description": "Lý do bị chặn (do admin nhập)"
            },
            "blocked_at": {
              "type": "string",
              "format": "date-time",
              "description": "Thời gian bị chặn"
            },
            "unblock_date": {
              "type": "string",
              "format": "date-time",
              "description": "Thời hạn gỡ chặn (nếu có)"
            },
            "admin_id": {
              "type": "string",
              "description": "ID của admin thực hiện hành động chặn"
            },
            "admin_signature": {
              "type": "string",
              "description": "Chữ ký số được tạo bởi ví của người dùng là admin "
            }
          },
          "required": [
            "_id",
            "card_id",
            "user_id",
            "reason",
            "blocked_at",
            "admin_id"
          ]
        },
        "jsonSample": [
          {
            "_id": "BLOCKED_001",
            "card_id": "C123456789",
            "user_id": "USER123",
            "reason": "Vi phạm chính sách sử dụng",
            "blocked_at": "2025-02-14T18:26:02.588Z",
            "unblock_date": "2025-03-14T18:26:02.588Z",
            "admin_id": "ADMIN-9876543210abcdef"
          }
        ]
      }
    },
    "private": {
      "node_function": {
        "edge": [
          {
            "pipeline": [
              {
                "$match": {
                  "status": "blocked"
                }
              },

              {
                "$lookup": {
                  "from": "collection_cards",
                  "localField": "card_id",
                  "foreignField": "card_id",
                  "as": "card_data"
                }
              },
              {
                "$unwind": "$card_data"
              },

              {
                "$addFields": {
                  "reason": "$reason_input",
                  "blocked_at": "$$NOW",
                  "admin_id": "$admin_input"
                }
              },

              {
                "$lookup": {
                  "from": "admin_collection_cards",
                  "localField": "admin_id",
                  "foreignField": "user_id",
                  "as": "admin_data"
                }
              },
              {
                "$unwind": "$admin_data"
              },
              {
                "$match": {
                  "$expr": {
                    "$in": ["change_user_status", "$admin_data.permissions"]
                  }
                }
              },

              {
                "$merge": {
                  "into": "blocked_cards",
                  "on": "_id",
                  "whenMatched": "replace",
                  "whenNotMatched": "insert"
                }
              },

              {
                "$merge": {
                  "into": "collection_cards",
                  "on": "card_id",
                  "whenMatched": "merge",
                  "whenNotMatched": "insert"
                }
              }
            ],
            "purpose": "Xử lý trạng thái 'blocked' và lưu lý do, thời gian bị chặn",
            "data_input_from_node": ["card_id", "reason_input", "admin_input"],
            "data_output_to_node": ["blocked_at", "unblock_date"]
          }
        ]
      }
    },
    "personal": {
      "node_info": {
        "name": "English Test System",
        "author": "Joshept",
        "version": "1.0",
        "year": "2025"
      }
    }
  },

  {
    "_id": "login_collection",
    "public": {
      "node_data": {
        "jsonSchema": {
          "$schema": "http://json-schema.org/draft-07/schema#",
          "title": "LoginData",
          "type": "object",
          "properties": {
            "_id": { "type": "string" },

            "admin_card_id": {
              "type": "string",
              "description": "Mã định danh duy nhất của thẻ dành cho admin (định dạng AC-<ECDSA>)"
            },
            "token": {
              "type": "string",
              "unique": true,
              "description": "Token phiên (JWT hoặc UUID)"
            },
            "expires_at": {
              "type": "string",
              "format": "date-time",
              "description": "Thời gian hết hạn của token"
            },
            "last_login": {
              "type": "string",
              "format": "date-time",
              "description": "Thời gian đăng nhập gần nhất"
            }
          },
          "required": ["admin_id", "admin_card_id", "token", "expires_at"]
        },
        "jsonSample": [
          {
            "_id": "LOGIN_001",
            "admin_id": "ADMIN-1a2b3c4d5e6f7890",
            "admin_card_id": "AC123456789",
            "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.xxxxx",
            "expires_at": "2025-02-14T19:26:02.588Z",
            "last_login": "2025-02-14T18:26:02.588Z"
          }
        ]
      }
    },
    "private": {
      "node_function": {
        "edge": [
          {
            "pipeline": [
              {
                "$lookup": {
                  "from": "admin_collection_cards",
                  "localField": "admin_id",
                  "foreignField": "admin_id",
                  "as": "admin_data"
                }
              },
              {
                "$unwind": "$admin_data"
              },
              {
                "$match": {
                  "$expr": {
                    "$and": [
                      {
                        "$eq": ["$admin_card_id", "$admin_data.admin_card_id"]
                      },
                      { "$eq": ["$public_key", "$admin_data.public_key"] },
                      {
                        "$eq": [
                          "$admin_signature",
                          "$admin_data.admin_signature"
                        ]
                      }
                    ]
                  }
                }
              },

              {
                "$addFields": {
                  "token": {
                    "$function": {
                      "body": "function() { const crypto = require('crypto'); return crypto.randomBytes(32).toString('hex'); }",
                      "args": [],
                      "lang": "js"
                    }
                  },
                  "expires_at": {
                    "$dateAdd": {
                      "startDate": "$$NOW",
                      "unit": "hour",
                      "amount": 1
                    }
                  }
                }
              },

              {
                "$merge": {
                  "into": "login_collection",
                  "on": "_id",
                  "whenMatched": "replace",
                  "whenNotMatched": "insert"
                }
              }
            ],
            "purpose": "Xác thực người dùng và tạo token đăng nhập ngắn hạn",
            "data_input_from_node": [
              "admin_id",
              "admin_card_id",
              "public_key",
              "admin_signature"
            ],
            "data_output_to_node": ["token", "expires_at"]
          }
        ]
      }
    },
    "personal": {
      "node_info": {
        "name": "English Test System",
        "author": "Joshept",
        "version": "1.0",
        "year": "2025"
      }
    }
  },
  {
    "_id": "admin_action_logs",
    "public": {
      "node_data": {
        "jsonSchema": {
          "$schema": "http://json-schema.org/draft-07/schema#",
          "title": "LogData",
          "type": "object",
          "properties": {
            "_id": {
              "type": "string",
              "description": "ID duy nhất cho bản ghi log"
            },
            "action_id": {
              "type": "string",
              "description": "Mã định danh duy nhất cho hành động đã thực hiện"
            },
            "admin_id": {
              "type": "string",
              "description": "ID của admin thực hiện hành động (định dạng ADMIN-<UUID>)"
            },
            "admin_card_id": {
              "type": "string",
              "description": "Mã thẻ admin thực hiện hành động (định dạng AC-<ECDSA>)"
            },
            "action_type": {
              "type": "string",
              "description": "Loại hành động, ví dụ: create_user, delete_user, block_user"
            },
            "target_type": {
              "type": "string",
              "description": "Loại mục tiêu bị tác động, ví dụ: user, test, card"
            },
            "target_id": {
              "type": "string",
              "description": "ID của đối tượng bị tác động"
            },
            "description": {
              "type": "string",
              "description": "Mô tả chi tiết về hành động đã thực hiện"
            },
            "timestamp": {
              "type": "string",
              "format": "date-time",
              "description": "Thời gian diễn ra hành động"
            },
            "ip_address": {
              "type": "string",
              "description": "Địa chỉ IP từ nơi hành động được thực hiện"
            },
            "user_agent": {
              "type": "string",
              "description": "Thông tin trình duyệt và hệ điều hành của người dùng"
            },
            "status": {
              "type": "string",
              "enum": ["success", "failed"],
              "description": "Trạng thái của hành động: thành công hay thất bại"
            }
          },
          "required": [
            "_id",
            "action_id",
            "admin_id",
            "admin_card_id",
            "action_type",
            "target_type",
            "target_id",
            "description",
            "timestamp",
            "status"
          ]
        },
        "jsonSample": [
          {
            "_id": "LOG_001",
            "action_id": "ACT_1234567890",
            "admin_id": "ADMIN-1a2b3c4d5e6f7890",
            "admin_card_id": "AC123456789",
            "action_type": "create_user",
            "target_type": "user",
            "target_id": "USER123",
            "description": "Tạo tài khoản người dùng mới thành công.",
            "timestamp": "2025-04-05T10:00:00.000Z",
            "ip_address": "192.168.1.1",
            "user_agent": "Mozilla/5.0...",
            "status": "success"
          }
        ]
      }
    },
    "private": {
      "node_function": {
        "edge": [
          {
            "pipeline": [
              {
                "$addFields": {
                  "log_entry": {
                    "action_id": {
                      "$concat": ["ACTION-", { "$toString": "$$NOW" }]
                    },
                    "admin_id": "$admin_id",
                    "admin_card_id": "$admin_card_id",
                    "action_type": "create_user",
                    "target_type": "user",
                    "target_id": "$new_user_id",
                    "description": "Admin đã tạo tài khoản người dùng mới.",
                    "timestamp": "$$NOW",
                    "ip_address": "$client_ip",
                    "user_agent": "$user_agent",
                    "status": "success"
                  }
                }
              },
              {
                "$replaceRoot": {
                  "newRoot": "$log_entry"
                }
              },
              {
                "$merge": {
                  "into": "admin_action_logs",
                  "on": "_id",
                  "whenMatched": "merge",
                  "whenNotMatched": "insert"
                }
              }
            ],
            "purpose": "  Ghi lại hành động của admin khi tạo người dùng mới.",
            "data_input_from_node": [],
            "data_output_to_node": ["admin_action_logs"]
          },
          {
            "pipeline": [
              {
                "$setWindowFields": {
                  "output": {
                    "employee_input": "$$employee_id"
                  }
                }
              },
              {
                "$addFields": {
                  "hashed_adminID": {
                    "$function": {
                      "body": "function() { const crypto = require('crypto'); const uuid = crypto.randomBytes(16).toString('hex'); return 'ADMIN-' + uuid; }",
                      "args": ["$employee_input"],
                      "lang": "js"
                    }
                  }
                }
              },
              {
                "$lookup": {
                  "from": "admin_collection_cards",
                  "localField": "hashed_adminID",
                  "foreignField": "hashed_adminID",
                  "as": "admin_info"
                }
              },
              {
                "$unwind": {
                  "path": "$admin_info",
                  "preserveNullAndEmptyArrays": false
                }
              },
              {
                "$replaceRoot": {
                  "newRoot": "$admin_info"
                }
              }
            ],
            "purpose": " Lấy thông tin admin từ `admin_collection_cards` dựa trên `hashed_adminID`.",
            "data_input_from_node": ["admin_collection_cards"],
            "data_output_to_node": ["admin_action_logs"]
          }
        ]
      }
    },
    "personal": {
      "node_info": {
        "name": "English Test System",
        "author": "Joshept",
        "version": "1.0",
        "year": "2025"
      }
    }
  },
    {
    "_id": "collection_user_transactions",
    "public": {
      "node_data": {
        "jsonSchema": {
          "$schema": "http://json-schema.org/draft-07/schema#",
          "title": "UserTransactionData",
          "type": "object",
          "properties": {
            "_id": {
              "type": "string",
              "description": "ID duy nhất của giao dịch."
            },
            "user_id": {
              "type": "string",
              "unique": true,
              "description": "ID người dùng thực hiện giao dịch."
            },
            "transaction_type": {
              "type": "string",
              "enum": ["deposit", "payment", "reward"],
              "description": "Loại giao dịch: nạp tiền, thanh toán, hoặc thưởng."
            },
            "amount": {
              "type": "integer",
              "minimum": 10000,
              "maximum": 1000000,
              "description": "Số tiền liên quan đến giao dịch (đơn vị VND)."
            },
            "description": {
              "type": "string",
              "description": "Mô tả chi tiết về giao dịch."
            },
            "created_at": {
              "type": "string",
              "format": "date-time",
              "description": "Thời gian giao dịch được tạo."
            },
            "card_id": {
              "type": "string",
              "unique": true,
              "description": "ID thẻ xác minh người dùng."
            },
            "signature": {
              "type": "string",
              "description": "Chữ ký số được tạo bởi ví của người dùng."
            },
            "public_key": {
              "type": "string",
              "description": "Khóa công khai để xác thực chữ ký số."
            },
            "status": {
              "type": "string",
              "enum": ["pending", "completed", "failed", "refunded"],
              "description": "Trạng thái của giao dịch."
            }
          },
          "required": [
            "_id",
            "user_id",
            "transaction_type",
            "amount",
            "description",
            "created_at",
            "status"
          ],
          "additionalProperties": false
        },
        "jsonSample": [
          {
            "_id": "txn_001",
            "user_id": "user_123",
            "transaction_type": "deposit",
            "amount": 100000,
            "description": "Nạp tiền vào ví.",
            "created_at": "2025-02-14T18:26:02.588Z",
            "card_id": "card_456",
            "signature": "signature_789",
            "public_key": "public_key_abc",
            "status": "completed"
          },
          {
            "_id": "txn_002",
            "user_id": "user_456",
            "transaction_type": "payment",
            "amount": 50000,
            "description": "Thanh toán phí dịch vụ.",
            "created_at": "2025-02-14T18:27:15.345Z",
            "card_id": "card_789",
            "signature": "signature_def",
            "public_key": "public_key_xyz",
            "status": "pending"
          }
        ]
      }
    },
    "private": {
      "node_function": {
        "edge": [
          {
            "pipeline": [
              {
                "$match": {
                  "user_id": { "$exists": true },
                  "card_id": { "$exists": true }
                }
              },
              {
                "$lookup": {
                  "from": "collection_cards",
                  "localField": "card_id",
                  "foreignField": "card_id",
                  "as": "card_data"
                }
              },
              {
                "$unwind": "$card_data"
              },
              {
                "$addFields": {
                  "is_balance_sufficient": {
                    "$gte": ["$card_data.balance", "$amount"]
                  }
                }
              },
              {
                "$merge": {
                  "into": "collection_user_transactions",
                  "on": "_id",
                  "whenMatched": "merge",
                  "whenNotMatched": "insert"
                }
              }
            ],
            "purpose": "Kiểm tra số dư trong collection_cards.balance trước khi thanh toán.",
            "data_input_from_node": ["collection_user_transactions"],
            "data_output_to_node": ["collection_user_transactions"]
          },
          {
            "pipeline": [
              {
                "$match": {
                  "user_OTP": { "$exists": true },
                  "user_id": { "$exists": true },
                  "transaction_type": "payment",
                  "status": "pending"
                }
              },
              {
                "$lookup": {
                  "from": "collection_cards",
                  "localField": "user_id",
                  "foreignField": "user_id",
                  "as": "card_data"
                }
              },
              {
                "$unwind": "$card_data"
              },
              {
                "$addFields": {
                  "is_OTP_valid": {
                    "$eq": ["$user_OTP", "$card_data.user_OTP"]
                  },
                  "created_at": "$$NOW",
                  "expiration_time": {
                    "$dateAdd": {
                      "startDate": "$$NOW",
                      "unit": "second",
                      "amount": 60
                    }
                  }
                }
              },
              {
                "$match": {
                  "is_OTP_valid": true,
                  "status": "pending",
                  "expiration_time": { "$gte": "$$NOW" }
                }
              },
              {
                "$set": {
                  "signature": "$card_data.signature"
                }
              },
              {
                "$merge": {
                  "into": "collection_user_transactions",
                  "on": "_id",
                  "whenMatched": "merge",
                  "whenNotMatched": "insert"
                }
              },
              {
                "$addFields": {
                  "is_signature_valid": {
                    "$cond": {
                      "if": { "$eq": ["$signature", "CLIENT_SIGNATURE"] },
                      "then": true,
                      "else": false
                    }
                  }
                }
              },
              {
                "$set": {
                  "status": {
                    "$cond": {
                      "if": {
                        "$and": [
                          "$is_signature_valid",
                          { "$lte": ["$$NOW", "$expiration_time"] }
                        ]
                      },
                      "then": "completed",
                      "else": "failed"
                    }
                  }
                }
              },
              {
                "$merge": {
                  "into": "collection_user_transactions",
                  "on": "_id",
                  "whenMatched": "merge",
                  "whenNotMatched": "fail"
                }
              }
            ],
            "purpose": "Xác thực OTP và chữ ký số của người dùng trước khi hoàn tất giao dịch.",
            "data_input_from_node": ["collection_cards"],
            "data_output_to_node": ["collection_user_transactions"]
          },
          {
            "pipeline": [
              {
                "$match": {
                  "user_id": { "$exists": true },
                  "transaction_type": "payment",
                  "amount": 10000,
                  "status": "pending",
                  "steps.status": "pending"
                }
              },
              {
                "$unwind": "$steps"
              },
              {
                "$match": {
                  "steps.status": "pending"
                }
              },
              {
                "$lookup": {
                  "from": "collection_cards",
                  "localField": "card_id",
                  "foreignField": "card_id",
                  "as": "card_data"
                }
              },
              {
                "$unwind": "$card_data"
              },
              {
                "$set": {
                  "is_balance_sufficient": {
                    "$gte": [
                      "$card_data.balance",
                      { "$divide": ["$amount", 5] }
                    ]
                  }
                }
              },
              {
                "$match": {
                  "is_balance_sufficient": true
                }
              },
              {
                "$set": {
                  "card_data.balance": {
                    "$subtract": [
                      "$card_data.balance",
                      { "$divide": ["$amount", 5] }
                    ]
                  },
                  "steps.$[step].status": "completed",
                  "steps.$[step].verified_at": "$$NOW"
                }
              },
              {
                "$lookup": {
                  "from": "collection_cards",
                  "localField": "user_id",
                  "foreignField": "user_id",
                  "as": "user_materials"
                }
              },
              {
                "$unwind": "$user_materials"
              },
              {
                "$set": {
                  "user_materials.remaining_attempts": {
                    "$add": ["$user_materials.remaining_attempts", 1]
                  }
                }
              },
              {
                "$merge": {
                  "into": "collection_cards",
                  "on": "card_id",
                  "whenMatched": "merge",
                  "whenNotMatched": "insert"
                }
              },
              {
                "$merge": {
                  "into": "collection_cards",
                  "on": "user_id",
                  "whenMatched": "merge",
                  "whenNotMatched": "insert"
                }
              },
              {
                "$merge": {
                  "into": "collection_user_transactions",
                  "on": "_id",
                  "whenMatched": "merge",
                  "whenNotMatched": "insert"
                }
              }
            ],
            "purpose": "Xử lý từng bước trong chuỗi giao dịch blockchain-style, trừ tiền từ collection_cards.balance và tăng remaining_attempts.",
            "data_input_from_node": ["collection_user_transactions"],
            "data_output_to_node": [
              "collection_cards",
              "collection_user_transactions"
            ]
          },
          {
            "pipeline": [
              {
                "$match": {
                  "_id": "TRANSACTION_ID",
                  "status": "pending"
                }
              },
              {
                "$addFields": {
                  "is_signature_valid": {
                    "$eq": ["$signature", "CLIENT_SIGNATURE"]
                  },
                  "is_within_time_limit": {
                    "$lte": ["$$NOW", "$expiration_time"]
                  }
                }
              },
              {
                "$set": {
                  "status": {
                    "$cond": {
                      "if": {
                        "$and": ["$is_signature_valid", "$is_within_time_limit"]
                      },
                      "then": "completed",
                      "else": "failed"
                    }
                  }
                }
              },
              {
                "$merge": {
                  "into": "collection_user_transactions",
                  "on": "_id",
                  "whenMatched": "merge",
                  "whenNotMatched": "fail"
                }
              }
            ],
            "purpose": "Xác thực chữ ký số và thời gian giao dịch.",
            "data_input_from_node": ["collection_user_transactions"],
            "data_output_to_node": [
              "collection_cards",
              "collection_user_transactions"
            ]
          },
          {
            "pipeline": [
              {
                "$match": {
                  "user_id": { "$exists": true },
                  "remaining_attempts": { "$gt": 0 }
                }
              },
              {
                "$set": {
                  "remaining_attempts": 2
                }
              },
              {
                "$merge": {
                  "into": "collection_cards",
                  "on": "user_id",
                  "whenMatched": "merge",
                  "whenNotMatched": "insert"
                }
              }
            ],
            "purpose": "Reset remaining_attempts về 2 nếu người dùng không sử dụng hết.",
            "data_input_from_node": ["collection_cards"],
            "data_output_to_node": ["collection_cards"]
          },
          {
            "pipeline": [
              {
                "$match": {
                  "steps.status": "pending"
                }
              },
              {
                "$lookup": {
                  "from": "collection_cards",
                  "localField": "card_id",
                  "foreignField": "card_id",
                  "as": "card_data"
                }
              },
              {
                "$unwind": "$card_data"
              },
              {
                "$set": {
                  "card_data.balance": {
                    "$add": [
                      "$card_data.balance",
                      {
                        "$multiply": [
                          { "$size": "$steps" },
                          { "$divide": ["$amount", 5] }
                        ]
                      }
                    ]
                  },
                  "steps.$[].status": "refunded"
                }
              },
              {
                "$merge": {
                  "into": "collection_cards",
                  "on": "card_id",
                  "whenMatched": "merge",
                  "whenNotMatched": "insert"
                }
              },
              {
                "$merge": {
                  "into": "collection_user_transactions",
                  "on": "_id",
                  "whenMatched": "merge",
                  "whenNotMatched": "insert"
                }
              }
            ],
            "purpose": "Hoàn tiền cho người dùng nếu block không hoàn thành.",
            "data_input_from_node": ["collection_user_transactions"],
            "data_output_to_node": [
              "collection_cards",
              "collection_user_transactions"
            ]
          },
          {
            "pipeline": [
              {
                "$match": {
                  "user_id": { "$exists": true },
                  "transaction_type": "payment",
                  "status": "failed"
                }
              },

              {
                "$lookup": {
                  "from": "collection_cards",
                  "localField": "card_id",
                  "foreignField": "_id",
                  "as": "card_data"
                }
              },
              {
                "$unwind": "$card_data"
              },
              {
                "$set": {
                  "card_data.balance": {
                    "$add": ["$card_data.balance", "$amount"]
                  }
                }
              },
              {
                "$merge": {
                  "into": "collection_cards",
                  "on": "_id",
                  "whenMatched": "merge",
                  "whenNotMatched": "fail"
                }
              },
              {
                "$set": {
                  "status": "refunded"
                }
              },
              {
                "$merge": {
                  "into": "collection_user_transactions",
                  "on": "_id",
                  "whenMatched": "merge",
                  "whenNotMatched": "fail"
                }
              }
            ],
            "purpose": "Hoàn tiền cho người dùng nếu giao dịch thanh toán thất bại.",
            "data_input_from_node": ["collection_user_transactions"],
            "data_output_to_node": [
              "collection_cards",
              "collection_user_transactions"
            ]
          }
        ]
      }
    },
    "personal": {
      "node_info": {
        "name": "English Test System",
        "author": "Joshept",
        "version": "1.0",
        "year": "2025"
      }
    }
  },

  {
    "_id": "web_product_cost",
    "public": {
      "node_data": {
        "jsonSchema": {
          "title": "WebProductCost",
          "type": "object",
          "properties": {
            "_id": { "type": "string" },
            "date": {
              "type": "string",
              "format": "date",
              "description": "Thời gian ghi nhận chi phí, theo định dạng YYYY-MM"
            },
            "currency": {
              "type": "string",
              "description": "Đơn vị tiền tệ (VND, VND, v.v.)"
            },
            "total_monthly_cost": {
              "type": "number",
              "description": "Tổng chi phí theo tháng"
            },
            "notes": {
              "type": "string",
              "description": "Ghi chú thêm liên quan đến chi phí"
            },
            "items": {
              "type": "array",
              "description": "Danh sách các khoản chi tiết",
              "items": {
                "type": "object",
                "properties": {
                  "name": { "type": "string", "description": "Tên khoản chi" },
                  "type": {
                    "type": "string",
                    "enum": ["infrastructure", "third_party", "tool"],
                    "description": "Loại khoản chi theo nhóm"
                  },
                  "category": {
                    "type": "string",
                    "enum": [
                      "server",
                      "hosting",
                      "domain",
                      "email",
                      "database",
                      "development",
                      "analytics",
                      "other"
                    ],
                    "description": "Phân loại chi phí chi tiết"
                  },
                  "description": {
                    "type": "string",
                    "description": "Mô tả khoản chi"
                  },
                  "amount": { "type": "number", "description": "Số tiền" },
                  "currency": {
                    "type": "string",
                    "description": "Đơn vị tiền tệ"
                  },
                  "is_paid": {
                    "type": "boolean",
                    "description": "Đã thanh toán hay chưa"
                  },
                  "provider": {
                    "type": "string",
                    "description": "Nhà cung cấp dịch vụ"
                  },
                  "billing_cycle": {
                    "type": "string",
                    "enum": ["monthly", "yearly", "one-time", "free"],
                    "description": "Chu kỳ thanh toán"
                  }
                },
                "required": [
                  "name",
                  "type",
                  "category",
                  "description",
                  "amount",
                  "currency",
                  "is_paid",
                  "provider",
                  "billing_cycle"
                ]
              }
            }
          },
          "required": [
            "_id",
            "date",
            "currency",
            "total_monthly_cost",
            "items"
          ],
          "additionalProperties": false
        },
        "jsonSample": [
          {
            "_id": "cost_2025_06",
            "date": "2025-06",
            "currency": "VND",
            "total_monthly_cost": 0,
            "notes": "Hiện tại đang dùng gói miễn phí nhiều dịch vụ, dự kiến sẽ phát sinh chi phí khi scale.",
            "items": [
              {
                "name": "Server Backend - Render",
                "type": "infrastructure",
                "category": "server",
                "description": "Chi phí cho instance backend chạy trên Render",
                "amount": 0,
                "currency": "VND",
                "is_paid": false,
                "provider": "Render",
                "billing_cycle": "monthly"
              },
              {
                "name": "Hosting Frontend - Netlify",
                "type": "infrastructure",
                "category": "hosting",
                "description": "Chi phí hosting frontend trên Netlify",
                "amount": 0,
                "currency": "VND",
                "is_paid": false,
                "provider": "Netlify",
                "billing_cycle": "monthly"
              },

              {
                "name": "CI/CD Pipeline",
                "type": "tool",
                "category": "development",
                "description": "Chi phí cho CI/CD trên GitHub Actions",
                "amount": 0,
                "currency": "VND",
                "is_paid": false,
                "provider": "GitHub",
                "billing_cycle": "monthly"
              },
              {
                "name": "Analytics Tools",
                "type": "tool",
                "category": "analytics",
                "description": "Sử dụng Google Analytics / Mixpanel",
                "amount": 0,
                "currency": "VND",
                "is_paid": false,
                "provider": "Google",
                "billing_cycle": "free"
              }
            ]
          }
        ]
      }
    },
    "private": {
      "node_function": {
        "edge": [
          {
            "pipeline": [
              {
                "$setWindowFields": {
                  "partitionBy": null,
                  "sortBy": "_id",
                  "output": {
                    "current_date": {
                      "$documentNumber": {}
                    }
                  }
                }
              },
              {
                "$unwind": {
                  "path": "$items"
                }
              },
              {
                "$addFields": {
                  "items.monthly_amount": {
                    "$cond": [
                      { "$eq": ["$items.billing_cycle", "monthly"] },
                      "$items.amount",
                      {
                        "$cond": [
                          { "$eq": ["$items.billing_cycle", "yearly"] },
                          { "$divide": ["$items.amount", 12] },
                          {
                            "$cond": [
                              { "$eq": ["$items.billing_cycle", "one-time"] },
                              0,
                              {
                                "$cond": [
                                  { "$eq": ["$items.billing_cycle", "free"] },
                                  0,
                                  0
                                ]
                              }
                            ]
                          }
                        ]
                      }
                    ]
                  }
                }
              },
              {
                "$group": {
                  "_id": "$_id",
                  "date": { "$first": "$date" },
                  "currency": { "$first": "$currency" },
                  "notes": { "$first": "$notes" },
                  "items": {
                    "$push": "$items"
                  },
                  "total_monthly_cost": {
                    "$sum": "$items.monthly_amount"
                  }
                }
              },
              {
                "$project": {
                  "items.monthly_amount": 0,
                  "items._id": 0
                }
              }
            ],
            "purpose": ""
          }
        ]
      }
    }
  },

  {
    "_id": "refundlogs",
    "public": {
      "node_data": {
        "jsonSchema": {
          "$schema": "https://json-schema.org/draft/2020-12/schema",
          "type": "object",
          "required": [
            "_id",
            "__v",
            "completed_steps",
            "failed_steps",
            "processed_at",
            "refunded_amount",
            "transaction_id",
            "user_id"
          ],
          "properties": {
            "_id": {
              "$ref": "#/$defs/ObjectId"
            },
            "__v": {
              "type": "integer"
            },
            "completed_steps": {
              "type": "integer"
            },
            "failed_steps": {
              "type": "integer"
            },
            "processed_at": {
              "$ref": "#/$defs/Date"
            },
            "refunded_amount": {
              "type": "integer"
            },
            "transaction_id": {
              "$ref": "#/$defs/ObjectId"
            },
            "user_id": {
              "type": "string"
            }
          },
          "$defs": {
            "ObjectId": {
              "type": "object",
              "properties": {
                "$oid": {
                  "type": "string",
                  "pattern": "^[0-9a-fA-F]{24}$"
                }
              },
              "required": ["$oid"],
              "additionalProperties": false
            },
            "Date": {
              "type": "object",
              "properties": {
                "$date": {
                  "type": "string",
                  "format": "date-time"
                }
              },
              "required": ["$date"],
              "additionalProperties": false
            }
          }
        },
        "jsonSample": [
          {
            "_id": {
              "$oid": "685026e46a6ce52a0129db19"
            },
            "transaction_id": {
              "$oid": "68463c3a17026cbed8859013"
            },
            "user_id": "78759033-a6ea-4c35-95df-959d4fde77f9",
            "refunded_amount": 9500,
            "failed_steps": 5,
            "completed_steps": 0,
            "processed_at": {
              "$date": "2025-06-16T14:15:00.494Z"
            },
            "__v": 0
          }
        ]
      }
    },
    "personal": {
      "node_info": {
        "name": "English Test System",
        "author": "Joshept",
        "version": "1.0",
        "year": "2025"
      }
    }
  },

  {
    "_id": "collection_system_revenue",
    "public": {
      "node_data": {
        "jsonSchema": {
          "$schema": "https://json-schema.org/draft/2020-12/schema",
          "type": "object",
          "required": [
            "_id",
            "admin_share_gross",
            "date",
            "share_breakdown",
            "share_total_check",
            "system_share_gross",
            "total_amount",
            "total_refunded"
          ],
          "properties": {
            "_id": {
              "$ref": "#/$defs/ObjectId"
            },
            "admin_share_gross": {
              "$ref": "#/$defs/Double"
            },
            "date": {
              "type": "string"
            },
            "share_breakdown": {
              "type": "array",
              "items": {
                "type": "object",
                "required": [
                  "gross",
                  "net_income",
                  "role",
                  "tax",
                  "taxable_income"
                ],
                "properties": {
                  "gross": {
                    "$ref": "#/$defs/Double"
                  },
                  "net_income": {
                    "$ref": "#/$defs/Double"
                  },
                  "role": {
                    "type": "string"
                  },
                  "tax": {
                    "type": "integer"
                  },
                  "taxable_income": {
                    "type": "integer"
                  }
                }
              }
            },
            "share_total_check": {
              "$ref": "#/$defs/Double"
            },
            "system_share_gross": {
              "$ref": "#/$defs/Double"
            },
            "total_amount": {
              "type": "integer"
            },
            "total_refunded": {
              "type": "integer"
            }
          },
          "$defs": {
            "ObjectId": {
              "type": "object",
              "properties": {
                "$oid": {
                  "type": "string",
                  "pattern": "^[0-9a-fA-F]{24}$"
                }
              },
              "required": ["$oid"],
              "additionalProperties": false
            },
            "Double": {
              "oneOf": [
                {
                  "type": "number"
                },
                {
                  "type": "object",
                  "properties": {
                    "$numberDouble": {
                      "enum": ["Infinity", "-Infinity", "NaN"]
                    }
                  }
                }
              ]
            }
          }
        },
        "jsonSample": [
          {
            "_id": {
              "$oid": "68504d545905e5e620fbbc8f"
            },
            "total_amount": 20000,
            "date": "2025-06-16",
            "total_refunded": 30400,
            "system_share_gross": -12400,
            "admin_share_gross": 2000,
            "share_breakdown": [
              {
                "role": "superadmin",
                "gross": 412,
                "taxable_income": 0,
                "tax": 0,
                "net_income": 412
              },
              {
                "role": "supervisor",
                "gross": 412,
                "taxable_income": 0,
                "tax": 0,
                "net_income": 412
              },
              {
                "role": "admin",
                "gross": 392,
                "taxable_income": 0,
                "tax": 0,
                "net_income": 392
              },
              {
                "role": "inspector_1",
                "gross": 392,
                "taxable_income": 0,
                "tax": 0,
                "net_income": 392
              },
              {
                "role": "inspector_2",
                "gross": 392,
                "taxable_income": 0,
                "tax": 0,
                "net_income": 392
              }
            ],
            "share_total_check": 2000
          }
        ]
      }
    },
    "private": {
      "node_function": {
        "edge": [
          {
            "pipeline": [
              {
                "$match": {
                  "transaction_type": "payment",
                  "status": "completed",
                  "created_at": {
                    "$exists": true
                  }
                }
              },

              {
                "$addFields": {
                  "created_date": {
                    "$dateToString": {
                      "format": "%Y-%m-%d",
                      "date": {
                        "$toDate": "$created_at"
                      },
                      "timezone": "Asia/Ho_Chi_Minh"
                    }
                  }
                }
              },

              {
                "$group": {
                  "_id": "$created_date",
                  "total_amount": {
                    "$sum": "$amount"
                  }
                }
              },
              {
                "$lookup": {
                  "from": "refundlogs",
                  "let": {
                    "dateStr": "$_id"
                  },
                  "pipeline": [
                    {
                      "$addFields": {
                        "processed_date": {
                          "$dateToParts": {
                            "date": "$processed_at",
                            "timezone": "Asia/Ho_Chi_Minh"
                          }
                        }
                      }
                    },
                    {
                      "$addFields": {
                        "processed_date_str": {
                          "$concat": [
                            {
                              "$toString": "$processed_date.year"
                            },
                            "-",
                            {
                              "$cond": [
                                {
                                  "$lt": ["$processed_date.month", 10]
                                },
                                {
                                  "$concat": [
                                    "0",
                                    {
                                      "$toString": "$processed_date.month"
                                    }
                                  ]
                                },
                                {
                                  "$toString": "$processed_date.month"
                                }
                              ]
                            },
                            "-",
                            {
                              "$cond": [
                                {
                                  "$lt": ["$processed_date.day", 10]
                                },
                                {
                                  "$concat": [
                                    "0",
                                    {
                                      "$toString": "$processed_date.day"
                                    }
                                  ]
                                },
                                {
                                  "$toString": "$processed_date.day"
                                }
                              ]
                            }
                          ]
                        }
                      }
                    },
                    {
                      "$match": {
                        "$expr": {
                          "$eq": ["$processed_date_str", "$$dateStr"]
                        }
                      }
                    }
                  ],
                  "as": "refund_logs"
                }
              },

              {
                "$addFields": {
                  "date": "$_id",
                  "total_refunded": {
                    "$sum": "$refund_logs.refunded_amount"
                  },
                  "system_share_gross": {
                    "$subtract": [
                      {
                        "$multiply": ["$total_amount", 0.9]
                      },
                      {
                        "$ifNull": [
                          {
                            "$sum": "$refund_logs.refunded_amount"
                          },
                          0
                        ]
                      }
                    ]
                  },
                  "admin_share_gross": {
                    "$multiply": ["$total_amount", 0.1]
                  },
                  "role_share_unit": {
                    "$divide": [
                      {
                        "$multiply": ["$total_amount", 0.1]
                      },
                      5.1
                    ]
                  }
                }
              },

              {
                "$addFields": {
                  "share_breakdown": [
                    {
                      "role": "superadmin",
                      "gross": {
                        "$round": [
                          {
                            "$multiply": ["$role_share_unit", 1.05]
                          },
                          0
                        ]
                      }
                    },
                    {
                      "role": "supervisor",
                      "gross": {
                        "$round": [
                          {
                            "$multiply": ["$role_share_unit", 1.05]
                          },
                          0
                        ]
                      }
                    },
                    {
                      "role": "admin",
                      "gross": {
                        "$round": ["$role_share_unit", 0]
                      }
                    },
                    {
                      "role": "inspector_1",
                      "gross": {
                        "$round": ["$role_share_unit", 0]
                      }
                    },
                    {
                      "role": "inspector_2",
                      "gross": {
                        "$subtract": [
                          "$admin_share_gross",
                          {
                            "$sum": [
                              {
                                "$round": [
                                  {
                                    "$multiply": ["$role_share_unit", 1.05]
                                  },
                                  0
                                ]
                              },
                              {
                                "$round": [
                                  {
                                    "$multiply": ["$role_share_unit", 1.05]
                                  },
                                  0
                                ]
                              },
                              {
                                "$round": ["$role_share_unit", 0]
                              },
                              {
                                "$round": ["$role_share_unit", 0]
                              }
                            ]
                          }
                        ]
                      }
                    }
                  ]
                }
              },

              {
                "$addFields": {
                  "share_breakdown": {
                    "$map": {
                      "input": "$share_breakdown",
                      "as": "s",
                      "in": {
                        "$let": {
                          "vars": {
                            "v_gross": "$$s.gross",
                            "v_taxable": {
                              "$max": [
                                0,
                                {
                                  "$subtract": ["$$s.gross", 11000000]
                                }
                              ]
                            }
                          },
                          "in": {
                            "$let": {
                              "vars": {
                                "v_tax": {
                                  "$switch": {
                                    "branches": [
                                      {
                                        "case": {
                                          "$lte": ["$$v_taxable", 0]
                                        },
                                        "then": 0
                                      },
                                      {
                                        "case": {
                                          "$lte": ["$$v_taxable", 5000000]
                                        },
                                        "then": {
                                          "$round": [
                                            {
                                              "$multiply": ["$$v_taxable", 0.05]
                                            },
                                            0
                                          ]
                                        }
                                      },
                                      {
                                        "case": {
                                          "$lte": ["$$v_taxable", 10000000]
                                        },
                                        "then": {
                                          "$round": [
                                            {
                                              "$subtract": [
                                                {
                                                  "$multiply": [
                                                    "$$v_taxable",
                                                    0.1
                                                  ]
                                                },
                                                250000
                                              ]
                                            },
                                            0
                                          ]
                                        }
                                      },
                                      {
                                        "case": {
                                          "$lte": ["$$v_taxable", 18000000]
                                        },
                                        "then": {
                                          "$round": [
                                            {
                                              "$subtract": [
                                                {
                                                  "$multiply": [
                                                    "$$v_taxable",
                                                    0.15
                                                  ]
                                                },
                                                750000
                                              ]
                                            },
                                            0
                                          ]
                                        }
                                      },
                                      {
                                        "case": {
                                          "$lte": ["$$v_taxable", 32000000]
                                        },
                                        "then": {
                                          "$round": [
                                            {
                                              "$subtract": [
                                                {
                                                  "$multiply": [
                                                    "$$v_taxable",
                                                    0.2
                                                  ]
                                                },
                                                1650000
                                              ]
                                            },
                                            0
                                          ]
                                        }
                                      },
                                      {
                                        "case": {
                                          "$lte": ["$$v_taxable", 52000000]
                                        },
                                        "then": {
                                          "$round": [
                                            {
                                              "$subtract": [
                                                {
                                                  "$multiply": [
                                                    "$$v_taxable",
                                                    0.25
                                                  ]
                                                },
                                                3250000
                                              ]
                                            },
                                            0
                                          ]
                                        }
                                      },
                                      {
                                        "case": {
                                          "$lte": ["$$v_taxable", 80000000]
                                        },
                                        "then": {
                                          "$round": [
                                            {
                                              "$subtract": [
                                                {
                                                  "$multiply": [
                                                    "$$v_taxable",
                                                    0.3
                                                  ]
                                                },
                                                5850000
                                              ]
                                            },
                                            0
                                          ]
                                        }
                                      }
                                    ],
                                    "default": {
                                      "$round": [
                                        {
                                          "$subtract": [
                                            {
                                              "$multiply": ["$$v_taxable", 0.35]
                                            },
                                            9850000
                                          ]
                                        },
                                        0
                                      ]
                                    }
                                  }
                                }
                              },

                              "in": {
                                "role": "$$s.role",
                                "gross": "$$v_gross",
                                "taxable_income": "$$v_taxable",
                                "tax": "$$v_tax",
                                "net_income": {
                                  "$subtract": ["$$v_gross", "$$v_tax"]
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              },

              {
                "$addFields": {
                  "share_total_check": {
                    "$sum": "$share_breakdown.gross"
                  },
                  "_id": {
                    "$concat": [
                      "revenue_",
                      {
                        "$replaceAll": {
                          "input": "$_id",
                          "find": "-",
                          "replacement": "_"
                        }
                      }
                    ]
                  }
                }
              },

              {
                "$project": {
                  "_id": 1,
                  "date": 1,
                  "total_refunded": 1,
                  "total_amount": 1,
                  "system_share_gross": 1,
                  "admin_share_gross": 1,
                  "share_breakdown": 1,
                  "share_total_check": 1
                }
              },

              {
                "$merge": {
                  "into": "collection_system_revenue",
                  "on": "_id",
                  "whenMatched": "merge",
                  "whenNotMatched": "insert"
                }
              }
            ],
            "purpose": "Tính toán doanh thu hệ thống từ các giao dịch thanh toán đã hoàn thành theo ngày.",
            "data_input_from_node": ["collection_transactions", "refundlogs"],
            "data_output_to_node": "collection_system_revenue"
          },

          {
            "pipeline": [
              {
                "$match": {
                  "transaction_type": "payment",
                  "status": "completed",
                  "created_at": {
                    "$exists": true
                  }
                }
              },
              {
                "$addFields": {
                  "created_date": {
                    "$dateToString": {
                      "format": "%Y-%m",
                      "date": {
                        "$toDate": "$created_at"
                      },
                      "timezone": "Asia/Ho_Chi_Minh"
                    }
                  }
                }
              },
              {
                "$group": {
                  "_id": "$created_date",
                  "total_amount": {
                    "$sum": "$amount"
                  },
                  "transactions_list": {
                    "$push": "$$ROOT"
                  }
                }
              },
              {
                "$lookup": {
                  "from": "refundlogs",
                  "let": {
                    "monthStr": "$_id"
                  },
                  "pipeline": [
                    {
                      "$addFields": {
                        "processed_month": {
                          "$dateToString": {
                            "format": "%Y-%m",
                            "date": "$processed_at",
                            "timezone": "Asia/Ho_Chi_Minh"
                          }
                        }
                      }
                    },
                    {
                      "$match": {
                        "$expr": {
                          "$eq": ["$processed_month", "$$monthStr"]
                        }
                      }
                    },
                    {
                      "$group": {
                        "_id": null,
                        "total_refunded": {
                          "$sum": "$refunded_amount"
                        }
                      }
                    }
                  ],
                  "as": "total_refunded"
                }
              },
              {
                "$addFields": {
                  "total_refunded": {
                    "$cond": [
                      {
                        "$isArray": "$total_refunded"
                      },
                      {
                        "$arrayElemAt": ["$total_refunded.total_refunded", 0]
                      },
                      0
                    ]
                  }
                }
              },
              {
                "$addFields": {
                  "date": "$_id",
                  "system_share_gross": {
                    "$subtract": [
                      {
                        "$multiply": ["$total_amount", 0.9]
                      },
                      {
                        "$ifNull": [
                          {
                            "$sum": "$refund_logs.refunded_amount"
                          },
                          0
                        ]
                      }
                    ]
                  },
                  "admin_share_gross": {
                    "$multiply": ["$total_amount", 0.1]
                  },
                  "role_share_unit": {
                    "$divide": [
                      {
                        "$multiply": ["$total_amount", 0.1]
                      },
                      5.1
                    ]
                  },
                  "generated_at": "$$NOW",
                  "generated_by": {
                    "$const": "system"
                  },
                  "report_period": {
                    "$const": "monthly"
                  }
                }
              },
              {
                "$addFields": {
                  "share_breakdown": [
                    {
                      "role": "superadmin",
                      "gross": {
                        "$round": [
                          {
                            "$multiply": ["$role_share_unit", 1.05]
                          },
                          0
                        ]
                      }
                    },
                    {
                      "role": "supervisor",
                      "gross": {
                        "$round": [
                          {
                            "$multiply": ["$role_share_unit", 1.05]
                          },
                          0
                        ]
                      }
                    },
                    {
                      "role": "admin",
                      "gross": {
                        "$round": ["$role_share_unit", 0]
                      }
                    },
                    {
                      "role": "inspector_1",
                      "gross": {
                        "$round": ["$role_share_unit", 0]
                      }
                    },
                    {
                      "role": "inspector_2",
                      "gross": {
                        "$subtract": [
                          "$admin_share_gross",
                          {
                            "$sum": [
                              {
                                "$round": [
                                  {
                                    "$multiply": ["$role_share_unit", 1.05]
                                  },
                                  0
                                ]
                              },
                              {
                                "$round": [
                                  {
                                    "$multiply": ["$role_share_unit", 1.05]
                                  },
                                  0
                                ]
                              },
                              {
                                "$round": ["$role_share_unit", 0]
                              },
                              {
                                "$round": ["$role_share_unit", 0]
                              }
                            ]
                          }
                        ]
                      }
                    }
                  ]
                }
              },
              {
                "$addFields": {
                  "share_breakdown": {
                    "$map": {
                      "input": "$share_breakdown",
                      "as": "s",
                      "in": {
                        "$let": {
                          "vars": {
                            "v_gross": "$$s.gross",
                            "v_taxable": {
                              "$max": [
                                0,
                                {
                                  "$subtract": ["$$s.gross", 11000000]
                                }
                              ]
                            }
                          },
                          "in": {
                            "$let": {
                              "vars": {
                                "v_tax": {
                                  "$switch": {
                                    "branches": [
                                      {
                                        "case": {
                                          "$lte": ["$$v_taxable", 0]
                                        },
                                        "then": 0
                                      },
                                      {
                                        "case": {
                                          "$lte": ["$$v_taxable", 5000000]
                                        },
                                        "then": {
                                          "$round": [
                                            {
                                              "$multiply": ["$$v_taxable", 0.05]
                                            },
                                            0
                                          ]
                                        }
                                      },
                                      {
                                        "case": {
                                          "$lte": ["$$v_taxable", 10000000]
                                        },
                                        "then": {
                                          "$round": [
                                            {
                                              "$subtract": [
                                                {
                                                  "$multiply": [
                                                    "$$v_taxable",
                                                    0.1
                                                  ]
                                                },
                                                250000
                                              ]
                                            },
                                            0
                                          ]
                                        }
                                      },
                                      {
                                        "case": {
                                          "$lte": ["$$v_taxable", 18000000]
                                        },
                                        "then": {
                                          "$round": [
                                            {
                                              "$subtract": [
                                                {
                                                  "$multiply": [
                                                    "$$v_taxable",
                                                    0.15
                                                  ]
                                                },
                                                750000
                                              ]
                                            },
                                            0
                                          ]
                                        }
                                      },
                                      {
                                        "case": {
                                          "$lte": ["$$v_taxable", 32000000]
                                        },
                                        "then": {
                                          "$round": [
                                            {
                                              "$subtract": [
                                                {
                                                  "$multiply": [
                                                    "$$v_taxable",
                                                    0.2
                                                  ]
                                                },
                                                1650000
                                              ]
                                            },
                                            0
                                          ]
                                        }
                                      },
                                      {
                                        "case": {
                                          "$lte": ["$$v_taxable", 52000000]
                                        },
                                        "then": {
                                          "$round": [
                                            {
                                              "$subtract": [
                                                {
                                                  "$multiply": [
                                                    "$$v_taxable",
                                                    0.25
                                                  ]
                                                },
                                                3250000
                                              ]
                                            },
                                            0
                                          ]
                                        }
                                      },
                                      {
                                        "case": {
                                          "$lte": ["$$v_taxable", 80000000]
                                        },
                                        "then": {
                                          "$round": [
                                            {
                                              "$subtract": [
                                                {
                                                  "$multiply": [
                                                    "$$v_taxable",
                                                    0.3
                                                  ]
                                                },
                                                5850000
                                              ]
                                            },
                                            0
                                          ]
                                        }
                                      }
                                    ],
                                    "default": {
                                      "$round": [
                                        {
                                          "$subtract": [
                                            {
                                              "$multiply": ["$$v_taxable", 0.35]
                                            },
                                            9850000
                                          ]
                                        },
                                        0
                                      ]
                                    }
                                  }
                                }
                              },
                              "in": {
                                "role": "$$s.role",
                                "gross": "$$v_gross",
                                "taxable_income": "$$v_taxable",
                                "tax": "$$v_tax",
                                "net_income": {
                                  "$subtract": ["$$v_gross", "$$v_tax"]
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              },
              {
                "$addFields": {
                  "share_total_check": {
                    "$sum": "$share_breakdown.gross"
                  }
                }
              },
              {
                "$lookup": {
                  "from": "web_product_cost",
                  "let": {
                    "monthStr": "$_id"
                  },
                  "pipeline": [
                    {
                      "$match": {
                        "$expr": {
                          "$eq": ["$date", "$$monthStr"]
                        }
                      }
                    }
                  ],
                  "as": "web_product_cost"
                }
              },
              {
                "$addFields": {
                  "total_web_product_cost": {
                    "$cond": [
                      {
                        "$isArray": "$web_product_cost"
                      },
                      {
                        "$arrayElemAt": ["$web_product_cost.amount", 0]
                      },
                      0
                    ]
                  }
                }
              },
              {
                "$addFields": {
                  "web_product_cost": {
                    "$arrayElemAt": ["$web_product_cost", 0]
                  }
                }
              },
              {
                "$addFields": {
                  "gross_profit_system": {
                    "$subtract": [
                      "$system_share_gross",
                      {
                        "$ifNull": ["$web_product_cost.total_monthly_cost", 0]
                      }
                    ]
                  }
                }
              },
              {
                "$project": {
                  "_id": 1,
                  "date": 1,
                  "total_refunded": 1,
                  "total_amount": 1,
                  "system_share_gross": 1,
                  "admin_share_gross": 1,
                  "share_breakdown": 1,
                  "share_total_check": 1,
                  "transactions_list": 1,
                  "gross_profit_system": 1,
                  "web_product_cost": 1,
                  "generated_at": 1,
                  "generated_by": 1,
                  "report_period": 1
                }
              },
              {
                "$merge": {
                  "into": "collection_system_revenue",
                  "on": "_id",
                  "whenMatched": "merge",
                  "whenNotMatched": "insert"
                }
              }
            ],
            "purpose": "Tính toán doanh thu hệ thống theo tháng từ các giao dịch thanh toán đã hoàn thành.",
            "data_input_from_node": "collection_transactions",
            "data_output_to_node": "collection_system_revenue"
          }
        ]
      }
    },
    "personal": {
      "node_info": {
        "name": "English Test System",
        "author": "Joshept",
        "version": "1.0",
        "year": "2025"
      }
    }
  }
]
