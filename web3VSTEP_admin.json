[
  {
    "_id": "admin_collection_cards",
    "public": {
      "node_data": {
        "jsonSchema": {
          "$schema": "http://json-schema.org/draft-07/schema#",
          "title": "AdminCardData",
          "type": "object",
          "properties": {
            "_id": { "type": "string" },
            "admin_card_id": {
              "type": "string",
              "unique": true,
              "description": "Mã định danh duy nhất của thẻ dành cho admin (định dạng AC-<ECDSA>)"
            },

            "public_key": {
              "type": "string",
              "description": "Khóa công khai để xác thực chữ ký số"
            },
            "token": { "type": "string", "required": true },
            "qr_code": {
              "type": "string",
              "description": "Mã QR chứa thông tin xác thực (đã mã hóa)"
            },
            "admin_signature": {
              "type": "string",
              "description": "Chữ ký số được tạo bởi ví của người dùng là admin "
            },
            "status": {
              "type": "string",
              "enum": ["active", "blocked"],
              "description": "Trạng thái thẻ"
            },

            "created_at": {
              "type": "string",
              "format": "date-time",
              "description": "Thời gian tạo thẻ"
            },
            "hashed_adminID": {
              "type": "string",
              "unique": true,
              "description": "Mã băm của ID admin (MÃ NHÂN VIÊN CỦA ADMIN) (định dạng ADMIN-<UUID>)"
            },
            "role": {
              "type": "string",
              "enum": ["superadmin", "admin"],
              "default": "admin",
              "description": "Vai trò của admin"
            },
            "permissions": {
              "type": "array",
              "items": { "type": "string" },
              "description": "Danh sách quyền (ví dụ: ['create_card', 'delete_user'])"
            },
            "last_login": {
              "type": "string",
              "format": "date-time",
              "description": "Thời gian đăng nhập gần nhất"
            },
            "active_sessions": {
              "type": "integer",
              "default": 0,
              "description": "Số phiên đăng nhập đang hoạt động"
            }
          },
          "required": [
            "_id",
            "admin_card_id",
            "public_key",
            "qr_code",
            "token",
            "status",
            "created_at",
            "hashed_adminID"
          ]
        },
        "jsonSample": []
      }
    },
    "private": {
      "node_function": {
        "edge": [
          {
            "pipeline": [
              {
                "$addFields": {
                  "admin_id": {
                    "$function": {
                      "body": "function() { const crypto = require('crypto'); const uuid = crypto.randomBytes(16).toString('hex'); return 'ADMIN-' + uuid; }",
                      "args": [],
                      "lang": "js"
                    }
                  }
                }
              },
              {
                "$addFields": {
                  "key_pair": {
                    "$function": {
                      "body": "function() { const crypto = require('crypto'); const { publicKey, privateKey } = crypto.generateKeyPairSync('ec', { namedCurve: 'secp256k1', publicKeyEncoding: { type: 'spki', format: 'pem' }, privateKeyEncoding: { type: 'pkcs8', format: 'pem' } }); return { publicKey, privateKey }; }",
                      "args": [],
                      "lang": "js"
                    }
                  }
                }
              },
              {
                "$addFields": {
                  "admin_card_id": {
                    "$function": {
                      "body": "function(privateKey) { const crypto = require('crypto'); const bs58 = require('bs58'); const seed = crypto.randomBytes(16); const hash = crypto.createHash('sha256').update(seed).digest(); const sign = crypto.createSign('SHA256'); sign.update(hash); sign.end(); const admin_signature = sign.sign({ key: privateKey, format: 'pem', type: 'sec1' }, 'base64'); return 'AC-' + bs58.encode(Buffer.from(admin_signature, 'base64')); }",
                      "args": ["$private_key"],
                      "lang": "js"
                    }
                  }
                }
              },
              {
                "$addFields": {
                  "public_key": "$key_pair.publicKey",
                  "private_key": "$key_pair.privateKey"
                }
              },
              {
                "$addFields": {
                  "raw_qr_data": {
                    "admin_id": "$admin_id",
                    "admin_card_id": "$admin_card_id",
                    "public_key": "$public_key"
                  }
                }
              },
              {
                "$addFields": {
                  "encrypted_qr_data": {
                    "$function": {
                      "body": "function(data, secretKey) { const crypto = require('crypto'); const cipher = crypto.createCipher('aes-256-cbc', secretKey); let encrypted = cipher.update(JSON.stringify(data), 'utf8', 'hex'); encrypted += cipher.final('hex'); return encrypted; }",
                      "args": ["$raw_qr_data", "jwt-secret-key"],
                      "lang": "js"
                    }
                  }
                }
              },
              {
                "$addFields": {
                  "admin_signature": {
                    "$function": {
                      "body": "function(privateKey, qr_data) { const crypto = require('crypto'); const sign = crypto.createSign('SHA256'); sign.update(qr_data); sign.end(); return sign.sign(privateKey, 'base64'); }",
                      "args": ["$private_key", "$encrypted_qr_data"],
                      "lang": "js"
                    }
                  }
                }
              },
              {
                "$addFields": {
                  "qr_code": {
                    "$function": {
                      "body": "function(encryptedData, sig) { return `https://example.com/cards/decrypt?data=${encodeURIComponent(encryptedData)}&admin_signature=${encodeURIComponent(sig)}`; }",
                      "args": ["$encrypted_qr_data", "$admin_signature"],
                      "lang": "js"
                    }
                  }
                }
              },

              {
                "$addFields": {
                  "hashed_adminID": {
                    "$function": {
                      "body": "function(input) { const crypto = require('crypto'); return crypto.createHash('sha256').update(input).digest('hex'); }",
                      "args": ["$admin_id"],
                      "lang": "js"
                    }
                  }
                }
              },
              {
                "$unset": ["key_pair", "private_key", "raw_qr_data"]
              },
              {
                "$merge": {
                  "into": "admin_collection_cards",
                  "on": "_id",
                  "whenMatched": "merge",
                  "whenNotMatched": "insert"
                }
              }
            ],
            "purpose": "Create admin cards with admin_id in ADMIN-<UUID> format and additional admin-specific fields.",
            "data_input_from_node": [],
            "data_output_to_node": []
          }
        ]
      }
    },
    "personal": {
      "node_info": {
        "name": "English Test System",
        "author": "Joshept",
        "version": "1.0",
        "year": "2025"
      }
    }
  },

  {
    "_id": "admin_draft_tests",
    "public": {
      "node_data": {
        "jsonSchema": {
          "$schema": "http://json-schema.org/draft-07/schema#",
          "title": "DraftTestSchema",
          "type": "object",
          "properties": {
            "_id": "string",
            "test_id": "string",
            "admin_card_id": {
              "type": "string",
              "unique": true,
              "description": "truy vấn trong admin_collection_cards"
            },
            "admin_signature": {
              "type": "string",
              "description": "truy vấn trong admin_collection_cards"
            },
            "superadmin_signature": {
              "type": "string",
              "description": "truy vấn trong admin_collection_cards"
            },
            "admin_signed_at": {
              "type": "date-time",
              "description": "Thời gian admin ký"
            },
            "superadmin_signed_at": {
              "type": "date-time",
              "description": "Thời gian superadmin ký"
            },
            "rejected_reason": {
              "type": "string",
              "description": "Lý do bài test bị từ chối bởi admin hoặc superadmin"
            },
            "test_type": { "type": "string", "enum": ["listening", "reading"] },
            "level": { "type": "string", "enum": ["B1", "B2", "C1"] },
            "created_by": "string",
            "created_at": "date-time",
            "status": {
              "type": "string",
              "enum": ["draft", "pending_review", "rejected", "approved"],
              "default": "draft",
              "description": "Trạng thái của bài kiểm tra"
            }
          },
          "allOf": [
            {
              "if": {
                "properties": { "test_type": { "const": "listening" } }
              },
              "then": {
                "properties": {
                  "audio_url": {
                    "type": "string",
                    "format": "uri",
                    "description": "URL của file audio. Trường này chứa URL của file audio, dù là từ upload hoặc nhập trực tiếp."
                  },
                  "questions": {
                    "type": "array",
                    "items": {
                      "type": "object",
                      "properties": {
                        "question_id": { "type": "string" },
                        "question_text": { "type": "string" },
                        "options": {
                          "type": "array",
                          "items": { "type": "string" },
                          "minItems": 4,
                          "maxItems": 4
                        },
                        "correct_answer": { "type": "string" }
                      },
                      "required": [
                        "question_id",
                        "question_text",
                        "options",
                        "correct_answer",
                        "audio_url"
                      ]
                    }
                  }
                },
                "required": ["audio_url", "questions"]
              }
            },
            {
              "if": { "properties": { "test_type": { "const": "reading" } } },
              "then": {
                "properties": {
                  "instructions": { "type": "string" },
                  "passages": {
                    "type": "array",
                    "minItems": 4,
                    "maxItems": 4,
                    "items": {
                      "type": "object",
                      "properties": {
                        "passage_id": { "type": "string" },
                        "question_text": {
                          "type": "string",
                          "description": "Nội dung đoạn văn hoặc câu hỏi"
                        },
                        "questions": {
                          "type": "array",
                          "items": {
                            "type": "object",
                            "properties": {
                              "question_id": { "type": "string" },
                              "question_type": {
                                "type": "string",
                                "enum": ["multiple_choice", "short_answer"]
                              },
                              "text": { "type": "string" },
                              "options": {
                                "type": "array",
                                "items": { "type": "string" },
                                "minItems": 4,
                                "maxItems": 4
                              },
                              "correct_answer": { "type": "string" }
                            },
                            "required": [
                              "question_id",
                              "question_type",
                              "text",
                              "correct_answer"
                            ],
                            "allOf": [
                              {
                                "if": {
                                  "properties": {
                                    "question_type": {
                                      "const": "multiple_choice"
                                    }
                                  }
                                },
                                "then": {
                                  "required": ["options", "correct_answer"]
                                }
                              },
                              {
                                "if": {
                                  "properties": {
                                    "question_type": {
                                      "const": "short_answer"
                                    }
                                  }
                                },
                                "then": { "required": ["correct_answer"] }
                              }
                            ]
                          }
                        }
                      },
                      "required": ["passage_id", "question_text", "questions"]
                    }
                  }
                },
                "required": ["level", "instructions", "passages"]
              }
            }
          ],
          "additionalProperties": false
        },
        "jsonSample": [
          {
            "_id": "DRAFT_001",
            "test_id": "TEST_123456",
            "admin_card_id": "AC123456789",
            "admin_signature": "base64-encoded-signature",
            "test_type": "listening",
            "level": "B2",
            "created_by": "ADMIN-1a2b3c4d5e6f7890",
            "created_at": "2025-02-14T18:26:02.588Z",
            "status": "draft",
            "audio_url": "https://example.com/audio.mp3",
            "questions": [
              {
                "question_id": "Q1",
                "question_text": "What is the main idea of the audio?",
                "options": ["Option A", "Option B", "Option C", "Option D"],
                "correct_answer": "Option A"
              }
            ]
          },
          {
            "_id": "DRAFT_002",
            "test_id": "TEST_654321",
            "admin_card_id": "AC987654321",
            "admin_signature": "base64-encoded-signature",
            "test_type": "reading",
            "level": "C1",
            "created_by": "ADMIN-0a1b2c3d4e5f6789",
            "created_at": "2025-02-14T18:26:02.588Z",
            "status": "draft",
            "instructions": "Read the following passages and answer the questions.",
            "passages": [
              {
                "passage_id": "P1",
                "question_text": "Passage 1 content here.",
                "questions": [
                  {
                    "question_id": "Q1",
                    "question_type": "multiple_choice",
                    "text": "What is the main point of this passage?",
                    "options": ["A", "B", "C", "D"],
                    "correct_answer": "A"
                  },
                  {
                    "question_id": "Q2",
                    "question_type": "short_answer",
                    "text": "Explain the significance of the passage.",
                    "correct_answer": "Significance explanation here."
                  }
                ]
              }
            ]
          }
        ]
      }
    },
    "private": {
      "node_function": {
        "edge": [
          {
            "pipeline": [
              {
                "$match": {
                  "admin_card_id": { "$exists": true },
                  "test_type": { "$in": ["listening", "reading"] }
                }
              },
              {
                "$lookup": {
                  "from": "admin_collection_cards",
                  "localField": "admin_card_id",
                  "foreignField": "card_id",
                  "as": "admin_card_data"
                }
              },
              {
                "$unwind": "$admin_card_data"
              },
              {
                "$addFields": {
                  "is_admin_verified": {
                    "$cond": {
                      "if": { "$eq": ["$admin_card_data.status", "active"] },
                      "then": true,
                      "else": false
                    }
                  }
                }
              },
              {
                "$match": {
                  "is_admin_verified": true
                }
              },
              {
                "$addFields": {
                  "audio_processed": {
                    "$cond": {
                      "if": { "$ne": ["$audio_file", null] },
                      "then": {
                        "$function": {
                          "body": "function(audioFile) { const crypto = require('crypto'); const hash = crypto.createHash('sha256'); hash.update(audioFile); return hash.digest('hex'); }",
                          "args": ["$audio_file"],
                          "lang": "js"
                        }
                      },
                      "else": "$audio_url"
                    }
                  }
                }
              },
              {
                "$addFields": {
                  "final_audio_url": {
                    "$cond": {
                      "if": { "$ne": ["$audio_file", null] },
                      "then": "$audio_processed",
                      "else": "$audio_url"
                    }
                  }
                }
              },
              {
                "$match": {
                  "admin_signature": { "$exists": true }
                }
              },
              {
                "$addFields": {
                  "signature_verified": {
                    "$function": {
                      "body": "function(signature, publicKey) { const crypto = require('crypto'); const verify = crypto.createVerify('SHA256'); verify.update(JSON.stringify({ test_id: this.test_id, final_audio_url: this.final_audio_url })); verify.end(); return verify.verify(publicKey, signature, 'base64'); }",
                      "args": [
                        "$admin_signature",
                        "$admin_card_data.public_key"
                      ],
                      "lang": "js"
                    }
                  }
                }
              },
              {
                "$match": {
                  "signature_verified": true
                }
              },
              {
                "$merge": {
                  "into": "admin_draft_tests",
                  "on": "_id",
                  "whenMatched": "merge",
                  "whenNotMatched": "insert"
                }
              }
            ],
            "purpose": "Xử lý và xác minh dữ liệu đề thi trước khi lưu vào cơ sở dữ liệu.",
            "data_input_from_node": ["admin_collection_cards"],
            "data_output_to_node": ["admin_draft_tests"]
          },
          {
            "pipeline": [
              {
                "$match": {
                  "status": "pending_review",
                  "test_id": { "$exists": true }
                }
              },
              {
                "$lookup": {
                  "from": "admin_collection_cards",
                  "localField": "superadmin_card_id",
                  "foreignField": "card_id",
                  "as": "superadmin_card_data"
                }
              },
              { "$unwind": "$superadmin_card_data" },
              {
                "$addFields": {
                  "is_superadmin_verified": {
                    "$cond": {
                      "if": {
                        "$eq": ["$superadmin_card_data.status", "active"]
                      },
                      "then": true,
                      "else": false
                    }
                  }
                }
              },
              { "$match": { "is_superadmin_verified": true } },
              {
                "$set": {
                  "status": "approved",
                  "superadmin_signature": "$superadmin_card_data.signature",
                  "superadmin_signed_at": { "$toDate": "$$NOW" }
                }
              },
              {
                "$merge": {
                  "into": "admin_draft_tests",
                  "on": "_id",
                  "whenMatched": "merge"
                }
              },
              {
                "$project": {
                  "_id": "$test_id",
                  "test_type": 1,
                  "level": 1,
                  "audio_url": 1,
                  "questions": 1,
                  "instructions": 1,
                  "passages": 1,
                  "admin_signature": 1,
                  "admin_signed_at": 1,
                  "superadmin_signature": 1,
                  "superadmin_signed_at": 1
                }
              },
              {
                "$merge": {
                  "into": "collection_tests",
                  "on": "_id",
                  "whenMatched": "merge",
                  "whenNotMatched": "insert"
                }
              }
            ],
            "purpose": "Superadmin kiểm duyệt lần 2 và duyệt đề thi chính thức.",
            "data_input_from_node": ["admin_draft_tests"],
            "data_output_to_node": ["collection_tests"]
          },
          {
            "pipeline": [
              {
                "$match": {
                  "status": "pending_review",
                  "test_id": { "$exists": true }
                }
              },
              {
                "$set": {
                  "status": "rejected",
                  "rejected_by": "superadmin-id",
                  "rejected_at": { "$toDate": "$$NOW" },
                  "rejected_reason": "{{rejected_reason}}",
                  "superadmin_signature": "{{superadmin_signature}}",
                  "superadmin_signed_at": "{{superadmin_signed_at}}"
                }
              },
              {
                "$merge": {
                  "into": "admin_draft_tests",
                  "on": "_id",
                  "whenMatched": "merge"
                }
              }
            ],
            "purpose": "Superadmin từ chối đề thi chưa đạt chuẩn và giữ lại để admin chỉnh sửa.",
            "data_input_from_node": ["admin_draft_tests"],
            "data_output_to_node": ["admin_draft_tests"]
          }
        ]
      }
    },
    "personal": {
      "node_info": {
        "name": "English Test System",
        "author": "Joshept",
        "version": "1.0",
        "year": "2025"
      }
    }
  },

  {
    "_id": "admin_draft_practice_materials",
    "public": {
      "node_data": {
        "jsonSchema": {
          "_id": "string",
          "practice_id": "string",
          "admin_card_id": {
            "type": "string",
            "unique": true,
            "description": "Tham chiếu đến thẻ admin trong `admin_collection_cards`"
          },
          "admin_signature": {
            "type": "string",
            "description": "Chữ ký số của admin xác thực bài kiểm tra"
          },
          "test_type": { "type": "string", "enum": ["listening", "reading"] },
          "level": { "type": "string", "enum": ["B1", "B2", "C1"] },
          "created_by": "string",
          "created_at": "date-time",
          "status": {
            "type": "string",
            "enum": ["draft", "pending_review", "rejected"],
            "description": "Trạng thái của tài liệu thực hành"
          },
          "listening": {
            "type": "array",
            "minItems": 3,
            "maxItems": 3,
            "items": {
              "type": "object",
              "properties": {
                "part": {
                  "type": "integer",
                  "minimum": 1,
                  "maximum": 3
                },
                "audio_url": {
                  "type": "string",
                  "description": "Either a Base64-encoded audio file or a URL pointing to an audio file.",
                  "oneOf": [{ "format": "base64" }, { "format": "uri" }]
                },
                "questions": {
                  "type": "array",
                  "minItems": 1,
                  "maxItems": 15,
                  "items": {
                    "type": "object",
                    "properties": {
                      "question_id": { "type": "string" },
                      "question_text": { "type": "string" },
                      "options": {
                        "type": "array",
                        "minItems": 3,
                        "maxItems": 5,
                        "items": { "type": "string" }
                      },
                      "correct_answer": { "type": "string" }
                    },
                    "required": [
                      "question_id",
                      "question_text",
                      "options",
                      "correct_answer"
                    ]
                  }
                }
              },
              "required": ["part", "audio_url", "questions"]
            }
          },
          "reading": {
            "type": "array",
            "minItems": 4,
            "maxItems": 4,
            "items": {
              "type": "object",
              "properties": {
                "part": { "type": "integer", "minimum": 1, "maximum": 4 },
                "passage_id": { "type": "string" },
                "text": { "type": "string" },
                "questions": {
                  "type": "array",
                  "minItems": 1,
                  "maxItems": 15,
                  "items": {
                    "type": "object",
                    "properties": {
                      "question_id": { "type": "string" },
                      "question_text": { "type": "string" },
                      "options": {
                        "type": "array",
                        "minItems": 3,
                        "maxItems": 5,
                        "items": { "type": "string" }
                      },
                      "correct_answer": { "type": "string" }
                    },
                    "required": [
                      "question_id",
                      "question_text",
                      "options",
                      "correct_answer"
                    ]
                  }
                }
              },
              "required": ["part", "passage_id", "text", "questions"]
            }
          },
          "writing": {
            "type": "array",
            "minItems": 2,
            "maxItems": 2,
            "items": {
              "type": "object",
              "properties": {
                "part": { "type": "integer", "minimum": 1, "maximum": 2 },
                "prompt": { "type": "string" },
                "sample_answer": { "type": "string" }
              },
              "required": ["part", "prompt", "sample_answer"]
            }
          },
          "speaking": {
            "type": "array",
            "minItems": 3,
            "maxItems": 3,
            "items": {
              "type": "object",
              "properties": {
                "part": { "type": "integer", "minimum": 1, "maximum": 3 },
                "prompt": { "type": "string" },
                "sample_answer": { "type": "string" }
              },
              "required": ["part", "prompt", "sample_answer"]
            }
          }
        },
        "jsonSample": [
          {
            "_id": "DRAFT_PRACTICE_001",
            "practice_id": "PRACTICE_123456",
            "admin_card_id": "AC123456789",
            "admin_signature": "base64-encoded-signature",
            "test_type": "listening",
            "level": "B2",
            "created_by": "ADMIN-1a2b3c4d5e6f7890",
            "created_at": "2025-02-14T18:26:02.588Z",
            "status": "draft",
            "listening": [
              {
                "part": 1,
                "audio_url": "https://example.com/audio.mp3",
                "questions": [
                  {
                    "question_id": "Q1",
                    "question_text": "What is the main idea of the audio?",
                    "options": ["Option A", "Option B", "Option C", "Option D"],
                    "correct_answer": "Option A"
                  }
                ]
              }
            ],
            "reading": [
              {
                "part": 1,
                "passage_id": "P1",
                "text": "Passage content here.",
                "questions": [
                  {
                    "question_id": "Q1",
                    "question_text": "What is the main point of this passage?",
                    "options": ["A", "B", "C", "D"],
                    "correct_answer": "A"
                  }
                ]
              }
            ],
            "writing": [
              {
                "part": 1,
                "prompt": "Write an essay about the importance of education.",
                "sample_answer": "Education is crucial for personal and societal development."
              },
              {
                "part": 2,
                "prompt": "Describe your favorite book and its impact on you.",
                "sample_answer": "My favorite book is '1984' by George Orwell, which opened my eyes to the dangers of totalitarianism."
              },
              {
                "part": 3,
                "prompt": "Discuss the role of technology in modern education.",
                "sample_answer": "Technology has revolutionized education by providing access to vast resources and enabling online learning."
              }
            ],
            "speaking": [
              {
                "part": 1,
                "prompt": "Describe a memorable event in your life.",
                "sample_answer": "One of the most memorable events in my life was my graduation day, which marked the culmination of years of hard work."
              },
              {
                "part": 2,
                "prompt": "Discuss your favorite hobby and why you enjoy it.",
                "sample_answer": "My favorite hobby is painting, as it allows me to express my creativity and relax."
              },
              {
                "part": 3,
                "prompt": "Explain the importance of learning a second language.",
                "sample_answer": "Learning a second language opens up new opportunities for communication and understanding different cultures."
              }
            ]
          }
        ]
      }
    },
    "private": {
      "node_function": {
        "edge": [
          {
            "pipeline": [
              {
                "$match": {
                  "admin_card_id": { "$exists": true }
                }
              },
              {
                "$lookup": {
                  "from": "admin_collection_cards",
                  "localField": "admin_card_id",
                  "foreignField": "card_id",
                  "as": "admin_card_data"
                }
              },
              {
                "$unwind": "$admin_card_data"
              },
              {
                "$match": {
                  "admin_card_data.status": "active"
                }
              },
              {
                "$merge": {
                  "into": "admin_draft_practice_materials",
                  "on": "_id",
                  "whenMatched": "merge",
                  "whenNotMatched": "insert"
                }
              }
            ],
            "purpose": "Kiểm tra quyền admin thông qua admin_card_id và xác minh trạng thái thẻ.",
            "data_input_from_node": ["admin_collection_cards"],
            "data_output_to_node": ["admin_draft_practice_materials"]
          },
          {
            "pipeline": [
              {
                "$addFields": {
                  "processed_audio_url": {
                    "$cond": {
                      "if": {
                        "$regexMatch": {
                          "input": "$audio_url",
                          "regex": "^https?://.*$"
                        }
                      },
                      "then": "$audio_url",
                      "else": {
                        "$function": {
                          "body": "function(audioFile) { const crypto = require('crypto'); const hash = crypto.createHash('sha256'); hash.update(audioFile); return hash.digest('hex'); }",
                          "args": ["$audio_url"],
                          "lang": "js"
                        }
                      }
                    }
                  }
                }
              },
              {
                "$merge": {
                  "into": "admin_draft_practice_materials",
                  "on": "_id",
                  "whenMatched": "merge",
                  "whenNotMatched": "insert"
                }
              }
            ],
            "purpose": "Xử lý URL hoặc băm file audio trước khi lưu vào cơ sở dữ liệu.",
            "data_input_from_node": ["audio_url"],
            "data_output_to_node": ["admin_draft_practice_materials"]
          },
          {
            "pipeline": [
              {
                "$match": {
                  "status": "pending_review",
                  "admin_signature": { "$exists": false }
                }
              },
              {
                "$lookup": {
                  "from": "admin_collection_cards",
                  "localField": "admin_card_id",
                  "foreignField": "card_id",
                  "as": "admin_card_data"
                }
              },
              {
                "$unwind": "$admin_card_data"
              },
              {
                "$match": {
                  "admin_card_data.status": "active"
                }
              },
              {
                "$addFields": {
                  "requires_signature": true
                }
              },
              {
                "$merge": {
                  "into": "admin_draft_practice_materials",
                  "on": "_id",
                  "whenMatched": "merge",
                  "whenNotMatched": "insert"
                }
              }
            ],
            "purpose": "Yêu cầu chữ ký số từ admin sau khi đề thi đã hoàn thành.",
            "data_input_from_node": ["admin_collection_cards"],
            "data_output_to_node": ["admin_draft_practice_materials"]
          },
          {
            "pipeline": [
              {
                "$match": {
                  "status": "pending_review",
                  "admin_signature": { "$exists": true }
                }
              },
              {
                "$lookup": {
                  "from": "admin_collection_cards",
                  "localField": "admin_card_id",
                  "foreignField": "card_id",
                  "as": "admin_card_data"
                }
              },
              {
                "$unwind": "$admin_card_data"
              },
              {
                "$match": {
                  "admin_card_data.status": "active"
                }
              },
              {
                "$set": {
                  "status": "completed"
                }
              },
              {
                "$merge": {
                  "into": "admin_draft_practice_materials",
                  "on": "_id",
                  "whenMatched": "merge",
                  "whenNotMatched": "insert"
                }
              }
            ],
            "purpose": "Lưu dữ liệu vào cơ sở dữ liệu sau khi admin cung cấp chữ ký số và xác minh quyền admin.",
            "data_input_from_node": ["admin_collection_cards"],
            "data_output_to_node": ["admin_draft_practice_materials"]
          },
          {
            "pipeline": [
              {
                "$match": {
                  "status": "pending_review",
                  "test_id": { "$exists": true }
                }
              },
              {
                "$lookup": {
                  "from": "admin_collection_cards",
                  "localField": "superadmin_card_id",
                  "foreignField": "card_id",
                  "as": "superadmin_card_data"
                }
              },
              { "$unwind": "$superadmin_card_data" },
              {
                "$addFields": {
                  "is_superadmin_verified": {
                    "$cond": {
                      "if": {
                        "$eq": ["$superadmin_card_data.status", "active"]
                      },
                      "then": true,
                      "else": false
                    }
                  }
                }
              },
              { "$match": { "is_superadmin_verified": true } },
              {
                "$set": {
                  "status": "approved",
                  "superadmin_signature": "$superadmin_card_data.signature",
                  "superadmin_signed_at": { "$toDate": "$$NOW" }
                }
              },
              {
                "$merge": {
                  "into": "admin_draft_tests",
                  "on": "_id",
                  "whenMatched": "merge"
                }
              },
              {
                "$project": {
                  "_id": "$test_id",
                  "test_type": 1,
                  "level": 1,
                  "upload_date": 1,
                  "listening": 1,
                  "writing": 1,
                  "speaking": 1,
                  "admin_signature": 1,
                  "admin_signed_at": 1,
                  "superadmin_signature": 1,
                  "superadmin_signed_at": 1
                }
              },
              {
                "$merge": {
                  "into": "collection_tests",
                  "on": "_id",
                  "whenMatched": "merge",
                  "whenNotMatched": "insert"
                }
              }
            ],
            "purpose": "Superadmin kiểm duyệt lần 2 và duyệt đề thi chính thức.",
            "data_input_from_node": ["admin_draft_tests"],
            "data_output_to_node": ["collection_tests"]
          },
          {
            "pipeline": [
              {
                "$match": {
                  "status": "pending_review",
                  "test_id": { "$exists": true }
                }
              },
              {
                "$set": {
                  "status": "rejected",
                  "rejected_by": "superadmin-id",
                  "rejected_at": { "$toDate": "$$NOW" },
                  "rejected_reason": "{{rejected_reason}}",
                  "superadmin_signature": "{{superadmin_signature}}",
                  "superadmin_signed_at": "{{superadmin_signed_at}}"
                }
              },
              {
                "$merge": {
                  "into": "admin_draft_tests",
                  "on": "_id",
                  "whenMatched": "merge"
                }
              }
            ],
            "purpose": "Superadmin từ chối đề thi chưa đạt chuẩn và giữ lại để admin chỉnh sửa.",
            "data_input_from_node": ["admin_draft_tests"],
            "data_output_to_node": ["admin_draft_tests"]
          }
        ]
      }
    },
    "personal": {
      "node_info": {
        "name": "English Test System",
        "author": "Joshept",
        "version": "1.0",
        "year": "2025"
      }
    }
  },

  {
    "_id": "admin_blocked_cards",
    "public": {
      "node_data": {
        "jsonSchema": {
          "$schema": "http://json-schema.org/draft-07/schema#",
          "title": "BlockedCardSchema",
          "type": "object",
          "properties": {
            "_id": { "type": "string" },
            "card_id": {
              "type": "string",
              "description": "Tham chiếu đến `card_id` trong `collection_cards`"
            },
            "admin_card_id": {
              "type": "string",
              "unique": true,
              "description": "Mã định danh duy nhất của thẻ dành cho admin (định dạng AC-<ECDSA>)"
            },

            "user_id": {
              "type": "string",
              "description": "Tham chiếu đến `user_id` trong `collection_cards`"
            },
            "reason": {
              "type": "string",
              "description": "Lý do bị chặn (do admin nhập)"
            },
            "blocked_at": {
              "type": "string",
              "format": "date-time",
              "description": "Thời gian bị chặn"
            },
            "unblock_date": {
              "type": "string",
              "format": "date-time",
              "description": "Thời hạn gỡ chặn (nếu có)"
            },
            "admin_id": {
              "type": "string",
              "description": "ID của admin thực hiện hành động chặn"
            },
            "admin_signature": {
              "type": "string",
              "description": "Chữ ký số được tạo bởi ví của người dùng là admin "
            }
          },
          "required": [
            "_id",
            "card_id",
            "user_id",
            "reason",
            "blocked_at",
            "admin_id"
          ]
        },
        "jsonSample": [
          {
            "_id": "BLOCKED_001",
            "card_id": "C123456789",
            "user_id": "USER123",
            "reason": "Vi phạm chính sách sử dụng",
            "blocked_at": "2025-02-14T18:26:02.588Z",
            "unblock_date": "2025-03-14T18:26:02.588Z",
            "admin_id": "ADMIN-9876543210abcdef"
          }
        ]
      }
    },
    "private": {
      "node_function": {
        "edge": [
          {
            "pipeline": [
              {
                "$match": {
                  "status": "blocked"
                }
              },

              {
                "$lookup": {
                  "from": "collection_cards",
                  "localField": "card_id",
                  "foreignField": "card_id",
                  "as": "card_data"
                }
              },
              {
                "$unwind": "$card_data"
              },

              {
                "$addFields": {
                  "reason": "$reason_input",
                  "blocked_at": "$$NOW",
                  "admin_id": "$admin_input"
                }
              },

              {
                "$lookup": {
                  "from": "admin_collection_cards",
                  "localField": "admin_id",
                  "foreignField": "user_id",
                  "as": "admin_data"
                }
              },
              {
                "$unwind": "$admin_data"
              },
              {
                "$match": {
                  "$expr": {
                    "$in": ["change_user_status", "$admin_data.permissions"]
                  }
                }
              },

              {
                "$merge": {
                  "into": "blocked_cards",
                  "on": "_id",
                  "whenMatched": "replace",
                  "whenNotMatched": "insert"
                }
              },

              {
                "$merge": {
                  "into": "collection_cards",
                  "on": "card_id",
                  "whenMatched": "merge",
                  "whenNotMatched": "insert"
                }
              }
            ],
            "purpose": "Xử lý trạng thái 'blocked' và lưu lý do, thời gian bị chặn",
            "data_input_from_node": ["card_id", "reason_input", "admin_input"],
            "data_output_to_node": ["blocked_at", "unblock_date"]
          }
        ]
      }
    },
    "personal": {
      "node_info": {
        "name": "English Test System",
        "author": "Joshept",
        "version": "1.0",
        "year": "2025"
      }
    }
  },

  {
    "_id": "login_collection",
    "public": {
      "node_data": {
        "jsonSchema": {
          "$schema": "http://json-schema.org/draft-07/schema#",
          "title": "LoginData",
          "type": "object",
          "properties": {
            "_id": { "type": "string" },

            "admin_card_id": {
              "type": "string",
              "description": "Mã định danh duy nhất của thẻ dành cho admin (định dạng AC-<ECDSA>)"
            },
            "token": {
              "type": "string",
              "unique": true,
              "description": "Token phiên (JWT hoặc UUID)"
            },
            "expires_at": {
              "type": "string",
              "format": "date-time",
              "description": "Thời gian hết hạn của token"
            },
            "last_login": {
              "type": "string",
              "format": "date-time",
              "description": "Thời gian đăng nhập gần nhất"
            }
          },
          "required": ["admin_id", "admin_card_id", "token", "expires_at"]
        },
        "jsonSample": [
          {
            "_id": "LOGIN_001",
            "admin_id": "ADMIN-1a2b3c4d5e6f7890",
            "admin_card_id": "AC123456789",
            "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.xxxxx",
            "expires_at": "2025-02-14T19:26:02.588Z",
            "last_login": "2025-02-14T18:26:02.588Z"
          }
        ]
      }
    },
    "private": {
      "node_function": {
        "edge": [
          {
            "pipeline": [
              {
                "$lookup": {
                  "from": "admin_collection_cards",
                  "localField": "admin_id",
                  "foreignField": "admin_id",
                  "as": "admin_data"
                }
              },
              {
                "$unwind": "$admin_data"
              },
              {
                "$match": {
                  "$expr": {
                    "$and": [
                      {
                        "$eq": ["$admin_card_id", "$admin_data.admin_card_id"]
                      },
                      { "$eq": ["$public_key", "$admin_data.public_key"] },
                      {
                        "$eq": [
                          "$admin_signature",
                          "$admin_data.admin_signature"
                        ]
                      }
                    ]
                  }
                }
              },

              {
                "$addFields": {
                  "token": {
                    "$function": {
                      "body": "function() { const crypto = require('crypto'); return crypto.randomBytes(32).toString('hex'); }",
                      "args": [],
                      "lang": "js"
                    }
                  },
                  "expires_at": {
                    "$dateAdd": {
                      "startDate": "$$NOW",
                      "unit": "hour",
                      "amount": 1
                    }
                  }
                }
              },

              {
                "$merge": {
                  "into": "login_collection",
                  "on": "_id",
                  "whenMatched": "replace",
                  "whenNotMatched": "insert"
                }
              }
            ],
            "purpose": "Xác thực người dùng và tạo token đăng nhập ngắn hạn",
            "data_input_from_node": [
              "admin_id",
              "admin_card_id",
              "public_key",
              "admin_signature"
            ],
            "data_output_to_node": ["token", "expires_at"]
          }
        ]
      }
    },
    "personal": {
      "node_info": {
        "name": "English Test System",
        "author": "Joshept",
        "version": "1.0",
        "year": "2025"
      }
    }
  }
]
